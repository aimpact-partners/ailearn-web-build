System.register(["@beyond-js/widgets@1.1.0/render","@beyond-js/kernel@0.1.9/bundle","@beyond-js/kernel@0.1.9/styles","@beyond-js/react-18-widgets@1.1.2/page","@aimpact/ailearn-sdk@1.0.0/core","@beyond-js/kernel@0.1.9/texts","@aimpact/ailearn-app@0.1.6-dev.34/main-layout.widget","@aimpact/chat-sdk@1.2.0/chat-component.code","@beyond-js/reactive@1.2.0/model","@aimpact/media-manager@0.0.1-beta.1/recorder","@aimpact/chat-sdk@1.2.0/voice","@aimpact/ailearn-sdk@1.0.0/tracking","react@18.2.0","pragmate-ui@1.0.0-beta.6/components","pragmate-ui@1.0.0-beta.6/alert","@aimpact/chat-sdk@1.2.0/widgets/markdown","@aimpact/chat-sdk@1.2.0/session","@aimpact/ailearn-app@0.1.6-dev.34/components/ui","@beyond-js/react-18-widgets@1.1.2/hooks","pragmate-ui@1.0.0-beta.6/icons","pragmate-ui@1.0.0-beta.6/modal"],function(n,e){"use strict";var t,a,r,o,s,i,c,d,l,u,m,p,f,g,v,h,y,w,k,E,_,b,x;return n({Controller:void 0,AudioPlayer:void 0,View:void 0,RecordingButton:void 0,PermissionsErrorModal:void 0,RecordingControl:void 0,PermissionsModal:void 0}),{setters:[function(e){t=e},function(e){a=e},function(e){r=e},function(e){o=e},function(e){s=e},function(e){i=e},function(e){c=e},function(e){d=e},function(e){l=e},function(e){u=e},function(e){m=e},function(e){p=e},function(e){f=e},function(e){g=e},function(e){v=e},function(e){h=e},function(e){y=e},function(e){w=e},function(e){k=e},function(e){E=e},function(e){_=e}],execute:function(){x=a.Bundle,(b=new x({module:{vspecifier:"@aimpact/ailearn-app@0.1.6-dev.34/assignments/spoken",multibundle:!0},type:"widget"},e.meta.url).package()).dependencies.update([["@beyond-js/widgets/render",t],["@beyond-js/kernel/styles",r],["@beyond-js/react-18-widgets/page",o],["@aimpact/ailearn-sdk/core",s],["@beyond-js/kernel/texts",i],["@aimpact/ailearn-app/main-layout.widget",c],["@aimpact/chat-sdk/chat-component.code",d],["@beyond-js/reactive/model",l],["@aimpact/media-manager/recorder",u],["@aimpact/chat-sdk/voice",m],["@aimpact/ailearn-sdk/tracking",p],["react",f],["pragmate-ui/components",g],["pragmate-ui/alert",v],["@aimpact/chat-sdk/widgets/markdown",h],["@aimpact/chat-sdk/session",y],["@aimpact/ailearn-app/components/ui",w],["@beyond-js/react-18-widgets/hooks",k],["pragmate-ui/icons",E],["pragmate-ui/modal",_]]),brequire("@beyond-js/widgets/render").widgets.register([{name:"ailearn-assignments-spoken",vspecifier:"@aimpact/ailearn-app@0.1.6-dev.34/assignments/spoken.widget",is:"page",route:"/assignments/${assignmentId}/spoken/${id}",layout:"main-layout"}]),brequire("@beyond-js/kernel/styles").styles.register("@aimpact/ailearn-app@0.1.6-dev.34/assignments/spoken.widget"),(x=new Map).set("./controller",{hash:3286864425,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Controller=void 0;var a=e("@beyond-js/react-18-widgets/page"),n=e("./store"),r=e("./views");class o extends a.PageReactWidgetController{#store;createStore(){return this.#store=new n.StoreManager,this.#store}get Widget(){return r.View}show(){this.#store.load(this.uri.vars.get("assignmentId"),this.uri.vars.get("id"))}hide(){}}t.Controller=o}}),x.set("./store",{hash:1476292979,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.StoreManager=void 0;var a=e("@beyond-js/kernel/texts"),n=e("beyond_context"),r=e("@aimpact/ailearn-app/main-layout.widget"),o=e("@aimpact/chat-sdk/chat-component.code"),s=e("@beyond-js/reactive/model"),i=e("@aimpact/media-manager/recorder"),c=e("@aimpact/chat-sdk/voice"),d=e("@aimpact/ailearn-sdk/tracking");class l extends s.ReactiveModel{#model;get model(){return this.#model}#introduction;get introduction(){return this.#introduction}#activityId;#assignmentId;get assignmentId(){return this.#assignmentId}#items;get items(){return this.#items}#audioManager=new o.AudioManager(this);get audioManager(){return this.#audioManager}#voice;get voice(){return this.#voice}#recorder;get recorder(){return this.#recorder}#assessment;get assessment(){return this.#assessment}#paramsUri;get paramsUri(){return this.#paramsUri}#texts=new a.CurrentTexts(n.module.specifier);get texts(){return this.#texts?.value}get ready(){return super.ready&&this.#texts.ready}#found;get found(){return this.#found}get canConsumeCredits(){return this.#found}#tracking;get tracking(){return this.#tracking}constructor(){super(),this.#voice=new c.Voice,this.assignmentId||(this.#assignmentId=this.sessionId),this.#texts.on("change",this.triggerEvent),this.#recorder=new i.Recorder}async load(e,t){try{var a,n;r.LayoutBroker.overlay=!0,r.LayoutBroker.canConsumeCredits=!0,e===this.#assignmentId&&this.#activityId===t?r.LayoutBroker.addModel(this.#tracking):(this.#assignmentId=e,this.#activityId=t,a=d.Tracking.get({assignmentId:e}),n=await(this.#tracking=a).activities.load({id:t}),this.#model=n,r.LayoutBroker.addModel(this.#tracking),super.ready=!0,this.#found=!0,this.triggerEvent())}catch(e){console.trace(e),super.ready=!0,this.#found=!1,r.LayoutBroker.canConsumeCredits=!1}}sendSpoken=async e=>{try{var t={audio:e,assignmentId:this.#assignmentId,activityId:this.#activityId},a=await this.model.publishSpoken({params:t,type:"spoken"});return await this.#tracking.activities.load({id:this.#activityId}),a}catch(e){super.ready=!0,this.#found=!1}}}t.StoreManager=l}}),x.set("./views/analysis/feedback",{hash:1890784375,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Feedback=function(){const a=(0,r.useSpokenContext)().store,e=Object.keys(a.model.data);return n.default.createElement(n.default.Fragment,null,e.map((e,t)=>(e=a.model.data[e],n.default.createElement("article",{key:e.name.replace(" ",""),className:"assessment__analysis-item"},n.default.createElement("section",{className:"item__icon__container"},e.icon),n.default.createElement("section",null,n.default.createElement("header",null,n.default.createElement("h3",null,e.name)),n.default.createElement("p",null,e.feedback))))))};var n=e("react"),r=e("../context")}}),x.set("./views/analysis/index",{hash:3580035694,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Analysis=function(){const{texts:{assessments:e},store:t,setView:a}=(0,f.useSpokenContext)(),[n,r]=l.default.useState("feedback"),[,,]=l.default.useState(!1),o={feedback:p.Feedback},s=o[n],i=g.sessionWrapper.user.displayName,c=t.model.resources.specs.task?.replace("%1",i);return l.default.createElement("div",{className:"assessment-analysis__container"},l.default.createElement("header",null,l.default.createElement("div",{className:"flex-container space-between"},l.default.createElement("section",null,l.default.createElement(d.ButtonGroup,{selected:0,variant:"primary"},l.default.createElement(d.Button,{"data-view":"feedback",onClick:e=>{r(e.currentTarget.dataset.view)}},e.analysis),l.default.createElement(d.Button,{onClick:e=>{e.preventDefault(),a("recording")}},e.redo))))),l.default.createElement(u.Alert,{type:"info",className:"activity__info"},l.default.createElement(m.Markdown,{content:c})),l.default.createElement(s,null))};var d=e("pragmate-ui/components"),l=e("react"),u=e("pragmate-ui/alert"),m=e("@aimpact/chat-sdk/widgets/markdown"),p=e("./feedback"),f=e("../context"),g=e("@aimpact/chat-sdk/session")}}),x.set("./views/audio-player",{hash:1190578037,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioPlayer=function({src:e}){if(!e)return console.warn("not audio to process"),null;e=URL.createObjectURL(e);const a=n.default.useRef(null);return n.default.useEffect(()=>{const e=a.current,t=()=>{e.duration===1/0&&(e.currentTime=1e101,e.ontimeupdate=()=>{e.ontimeupdate=null,e.currentTime=0})};return e.addEventListener("loadedmetadata",onloadeddata),()=>e.removeEventListener("loadedmetadata",t)},[e]),e?n.default.createElement("div",{className:"audio-player"},n.default.createElement("audio",{controls:!0,preload:"metadata"},n.default.createElement("source",{src:e,type:"audio/mp3",ref:a}),"Your browser does not support the audio element.")):null};var n=e("react")}}),x.set("./views/context",{hash:3296568220,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.useSpokenContext=t.SpokenContext=void 0;var a=e("react");const n=t.SpokenContext=a.default.createContext({});t.useSpokenContext=()=>a.default.useContext(n)}}),x.set("./views/index",{hash:2395922384,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.View=function({store:e}){const[t,a]=(0,p.useState)(e.ready),[n]=(0,p.useState)(e.items),[r,o]=p.default.useState(e.model?.data?"analysis":"recording"),[s,i]=p.default.useState(!1),[c,d]=p.default.useState(!1),l=e.texts;var u,m;return(0,y.useBinder)([e],()=>{a(e.ready),o(e.model?.data?"analysis":"recording")}),t&&!e.found?p.default.createElement("app-missing",null):t?(u={store:e,recorder:e.recorder,recording:s,setRecording:i,texts:l,fetching:e.fetching,items:n,audio:e.recorder.audio,setView:o,sending:c,setSending:d,onSubmit:e=>{e.preventDefault()}},m="analysis"===r?g.Analysis:v.RecordingControl,p.default.createElement("div",null,p.default.createElement(h.SpokenContext.Provider,{value:u},p.default.createElement(f.ActivityHeader,{title:e.model.title,icon:"spoken",type:e.model.type}),p.default.createElement(f.PageContainer,null,p.default.createElement(m,null))))):p.default.createElement(f.PageLoader,{fetching:!0})};var p=e("react"),f=e("@aimpact/ailearn-app/components/ui"),g=e("./analysis"),v=e("./recording"),h=e("./context"),y=e("@beyond-js/react-18-widgets/hooks")}}),x.set("./views/recording/button",{hash:2375701035,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.RecordingButton=void 0;var w=e("react"),k=e("pragmate-ui/components"),E=e("./modal"),_=e("../context"),b=e("@aimpact/ailearn-app/main-layout.widget"),x=e("./error-modal");t.RecordingButton=({disabled:e,action:t,setAction:a})=>{const{texts:n,recorder:r,recording:o,setRecording:s,audio:i}=(0,_.useSpokenContext)(),[c,d]=(0,w.useState)(!1),[l,u]=(0,w.useState)(!1),[m,p]=(0,w.useState)(!1);var f=o?"stop":"mic",g=!o&&i,g=o?"stop":g?"redo":"record";const[v,h]=(0,w.useState)(globalThis?.localStorage.getItem("aimpact.recording.permission")),y=async e=>{try{d(!0),v&&"true"===v?(async()=>{try{await r.record(),s(!o),a("start")}catch(e){p(!0)}})():u(!0)}catch(e){console.error(e),p(!0)}finally{d(!1)}};return w.default.createElement(w.default.Fragment,null,w.default.createElement(k.Button,{variant:"primary",icon:f,fetching:c,onClick:"start"===t?async e=>{await r.stop(),s(!1),a("reset")}:e=>{e.preventDefault(),b.LayoutBroker.ensureCredits(y)},disabled:e||c},n[g]),w.default.createElement(E.PermissionsModal,{show:l,onClose:e=>{d(!1),u(!1)},onConfirm:()=>{r.hasPermissions().then(()=>{globalThis?.localStorage.setItem("aimpact.recording.permission","true"),h("true")}).catch(e=>{console.log("permisos no concedidos"),p(!0)})}}),w.default.createElement(x.PermissionsErrorModal,{show:m,onClose:()=>p(!1)}))}}}),x.set("./views/recording/error-modal",{hash:1218241359,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.PermissionsErrorModal=void 0;var n=e("react"),r=e("pragmate-ui/icons"),o=e("pragmate-ui/modal"),s=e("../context");t.PermissionsErrorModal=({show:e,onClose:t})=>{var a;return e?(e=(0,s.useSpokenContext)().texts,{title:e,description:a}=e.permissions.error,n.default.createElement(n.default.Fragment,null,n.default.createElement(o.AlertModal,{className:"modal--centered",open:!0,show:!0,onClose:t,centered:!0},n.default.createElement("div",{className:"permissions__modal-container"},n.default.createElement("div",{className:"title-intro__modal-container"},n.default.createElement("h3",null,e)),n.default.createElement(r.Icon,{className:"mic__modal-icon lg my-10",icon:"mic"}),n.default.createElement("p",{className:"description__modal-text"},a))))):null}}}),x.set("./views/recording/index",{hash:153949891,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.RecordingControl=void 0;var l=e("@aimpact/chat-sdk/session"),u=e("react"),m=e("pragmate-ui/alert"),p=e("@aimpact/chat-sdk/widgets/markdown"),f=e("../timer"),g=e("../context"),v=e("./tabs"),h=e("./result"),y=e("./button");t.RecordingControl=({disabled:e=!1})=>{var{texts:t,recording:a,sending:n,audio:r,store:o}=(0,g.useSpokenContext)(),s=u.default.useRef(null),a=!a&&r,r="recording-player__container"+(n?" is-sending":""),[i,c]=u.default.useState(""),d=l.sessionWrapper.user.displayName,d=o.model.resources.specs.task?.replace("%1",d),e={disabled:e,action:i,setAction:c};return u.default.createElement(u.default.Fragment,null,u.default.createElement(v.ButtonTabs,{available:!!o.model.data}),u.default.createElement(m.Alert,{type:"info",className:"activity__info"},u.default.createElement(p.Markdown,{content:d})),u.default.createElement("div",{className:"recording__container flex-container flex-center"},u.default.createElement("section",{ref:s,className:r},u.default.createElement("div",{className:"recording-player__content"},u.default.createElement(f.Timer,{action:i}),u.default.createElement(y.RecordingButton,{...e}),u.default.createElement(h.RecordingResult,{show:a})),n&&u.default.createElement("div",{className:"sending__data"},u.default.createElement("h3",{className:"sending-message"},t.assessments.processMessages[0])))))}}}),x.set("./views/recording/modal",{hash:957625054,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.PermissionsModal=void 0;var o=e("react"),s=e("pragmate-ui/icons"),i=e("pragmate-ui/modal"),c=e("../context");t.PermissionsModal=({show:e,onClose:t,onConfirm:a})=>{var n,r;return e?(n=(e=(0,c.useSpokenContext)().texts).permissions.title,r=e.permissions.description,o.default.createElement(o.default.Fragment,null,o.default.createElement(i.AlertModal,{className:"modal--centered",open:!0,show:!0,onClose:t,centered:!0,onConfirm:a},o.default.createElement("div",{className:"permissions__modal-container"},o.default.createElement("div",{className:"title-intro__modal-container"},o.default.createElement("span",{className:"intro__modal-text p2"},e.permissions.intro),o.default.createElement("h3",null,n)),o.default.createElement(s.Icon,{className:"mic__modal-icon lg my-10",icon:"mic"}),o.default.createElement("p",{className:"description__modal-text"},r))))):null}}}),x.set("./views/recording/result",{hash:3648048102,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.RecordingResult=function({show:e}){const{texts:t,audio:a,setView:n,store:r,setSending:o,sending:s}=(0,l.useSpokenContext)();if(e)return e=e=>{e.preventDefault(),o(!0),r.sendSpoken(a).then(e=>{n("analysis"),o(!1)}),setTimeout(()=>{globalThis.setTimeout(()=>{s&&o(!1)},45e3)},100)},i.default.createElement("div",{className:"recording__result-container"},i.default.createElement(c.AudioPlayer,{src:r.recorder.audio}),i.default.createElement(d.Button,{icon:"send",onClick:e,variant:"primary"},t.send))};var i=e("react"),c=e("../audio-player"),d=e("pragmate-ui/components"),l=e("../context")}}),x.set("./views/recording/tabs",{hash:2166838320,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ButtonTabs=function({available:e}){const{texts:t,setView:a}=(0,o.useSpokenContext)();return e?n.default.createElement("div",{className:"flex-container space-between"},n.default.createElement("section",null,n.default.createElement(r.ButtonGroup,{selected:1,variant:"primary"},n.default.createElement(r.Button,{"data-view":"feedback",onClick:e=>a("analysis")},t.assessments.analysis),n.default.createElement(r.Button,null,t.assessments.redo)))):null};var n=e("react"),r=e("pragmate-ui/components"),o=e("../context")}}),x.set("./views/recording/use-recording",{hash:2475814657,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.useRecording=function(){var{}=(0,n.useSpokenContext)(),[e,t]=a.default.useState(!1);return{showModal:e,setShowModal:t}};var a=e("react"),n=e("../context")}}),x.set("./views/timer/index",{hash:3970133054,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Timer=function({action:e}){var t=["restart","start"].includes(e),a=["restart","reset"].includes(e),[,t,a,,]=(0,r.useTimer)(t,a,"reset"===e),e=a.toString().padStart(2,"0"),a=t.toString().padStart(2,"0");return n.default.createElement("div",{className:"timer__container"},n.default.createElement("span",null,""+a),n.default.createElement("span",{className:"timer__separator"},":"),n.default.createElement("span",null,""+e))};var n=e("react"),r=e("./use-timer")}}),x.set("./views/timer/use-timer",{hash:1583638382,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.useTimer=function(t,e,a=!0){const[n,r]=d(0),o=(l(()=>{let e;return a&&r(0),t&&(e=setInterval(()=>{r(e=>e+1)},10)),()=>{clearInterval(e)}},[t]),l(()=>{e&&r(0)},[e]),n%100),s=Math.floor(n/100%60),i=Math.floor(n/6e3%60),c=Math.floor(n/36e4);return[c,i,s,o]};const{useState:d,useEffect:l}=e("react").default}}),b.exports.descriptor=[{im:"./controller",from:"Controller",name:"Controller"},{im:"./views/audio-player",from:"AudioPlayer",name:"AudioPlayer"},{im:"./views/index",from:"View",name:"View"},{im:"./views/recording/button",from:"RecordingButton",name:"RecordingButton"},{im:"./views/recording/error-modal",from:"PermissionsErrorModal",name:"PermissionsErrorModal"},{im:"./views/recording/index",from:"RecordingControl",name:"RecordingControl"},{im:"./views/recording/modal",from:"PermissionsModal",name:"PermissionsModal"}],b.exports.process=function({require:e,prop:t,value:a}){!e&&"Controller"!==t||n("Controller",e?e("./controller").Controller:a),!e&&"AudioPlayer"!==t||n("AudioPlayer",e?e("./views/audio-player").AudioPlayer:a),!e&&"View"!==t||n("View",e?e("./views/index").View:a),!e&&"RecordingButton"!==t||n("RecordingButton",e?e("./views/recording/button").RecordingButton:a),!e&&"PermissionsErrorModal"!==t||n("PermissionsErrorModal",e?e("./views/recording/error-modal").PermissionsErrorModal:a),!e&&"RecordingControl"!==t||n("RecordingControl",e?e("./views/recording/index").RecordingControl:a),!e&&"PermissionsModal"!==t||n("PermissionsModal",e?e("./views/recording/modal").PermissionsModal:a)},n("__beyond_pkg",b),n("hmr",new function(){this.on=(e,t)=>b.hmr.on(e,t),this.off=(e,t)=>b.hmr.off(e,t)}),b.initialise(x)}}});