System.register(["@beyond-js/kernel@0.1.9/bundle","@beyond-js/reactive@1.1.12/settings","@beyond-js/reactive@1.1.12/model","@beyond-js/reactive@1.1.12/database","@beyond-js/kernel@0.1.9/core","dexie@3.2.7","@beyond-js/events@0.0.4/events","uuid@9.0.1"],function(i,e){"use strict";var t,r,s,a,o,n,l,d,h,c;return i({TCustomAdapter:void 0,IConfig:void 0,IResponseAdapter:void 0,Collection:void 0,CollectionLocalProvider:void 0,Book:void 0,IProvider:void 0,Item:void 0,IItem:void 0,LocalProvider:void 0,CollectionProvider:void 0,ItemProvider:void 0,RegistryFactory:void 0,StoreRecords:void 0}),{setters:[function(e){t=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){o=e},function(e){n=e},function(e){l=e},function(e){d=e}],execute:function(){c=t.Bundle,(h=new c({module:{vspecifier:"@beyond-js/reactive@1.1.12/entities"},type:"ts"},e.meta.url).package()).dependencies.update([["@beyond-js/reactive/settings",r],["@beyond-js/reactive/model",s],["@beyond-js/reactive/database",a],["@beyond-js/kernel/core",o],["dexie",n],["@beyond-js/events/events",l],["uuid",d]]),(c=new Map).set("./adapter/default",{hash:351600073,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultAdapter=void 0,t.DefaultAdapter=class{toClient(e){return Promise.resolve(e)}fromRemote(e){return Promise.resolve(e)}fromRemoteList(e){return Promise.resolve(e)}}}}),c.set("./adapter/index",{hash:1352406609,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ResponseAdapter=void 0;var r=e("@beyond-js/reactive/settings"),i=e("./default"),s=e("./legacy");t.ResponseAdapter=class{static get(e,t){return new("default"===(t=t||r.ReactiveConfig.adapter)?i.DefaultAdapter:s.LegacyAdapter)(e)}}}}),c.set("./adapter/interface",{hash:2454168762,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}}),c.set("./adapter/legacy",{hash:817405111,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.LegacyAdapter=void 0,t.LegacyAdapter=class{#parent;constructor(e){this.#parent=e}toClient(e={}){return e}fromRemote(e){var{}=e;return e}fromRemoteList(e){return Promise.resolve(e)}}}}),c.set("./cache/index",{hash:4043341357,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CacheManager=void 0;class r extends e("@beyond-js/reactive/model").ReactiveModel{}t.CacheManager=r}}),c.set("./collection/index",{hash:134723810,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Collection=void 0;var r=e("@beyond-js/reactive/model"),i=e("./local-provider"),s=e("./publish"),a=e("./load"),o=e("../adapter");class n extends r.ReactiveModel{db;item;localdb=!0;p;#elements=new Map;get elements(){return this.#elements}get items(){return this.orderBy?[...this.#elements.values()].sort((e,t)=>e[this.orderBy]>t[this.orderBy]?-1:e[this.orderBy]<t[this.orderBy]?1:0):[...this.#elements.values()]}get isOnline(){return!this.localProvider||this.localProvider.isOnline}set items(e){Array.isArray(e)&&(this.#elements.clear(),e.forEach(e=>this.#elements.set(e.id,e)),this.triggerEvent())}counters={};total=0;next;#localProvider;get localProvider(){return this.#localProvider}#saveManager;#loadManager;#provider;get provider(){return this.#provider}sortBy="id";orderBy="timeCreated";sortDirection="asc";#responseAdapter;get responseAdapter(){return this.#responseAdapter}#initialSpecs;constructor(e){super({properties:["total","next"]});var{provider:t,storeName:r,db:i,localdb:s,item:a}=e;if(this.#initialSpecs=e,r&&(this.storeName=r),i&&(this.db=i),this.localdb=void 0===s||s,a&&(this.item=a),t){if("function"!=typeof t)throw new Error("Provider must be a class object");this.#provider=new t}this.reactiveProps(["next"]),this.init()}init(){var e={get:e=>this[e],set:(e,t)=>this[e]=t,clear:this.#clear.bind(this)};this.#responseAdapter=o.ResponseAdapter.get(this,this.#initialSpecs?.adapter),this.#localProvider=new i.CollectionLocalProvider(this,e),this.#saveManager=new s.CollectionSaveManager(this,e),this.#loadManager=new a.CollectionLoadManager({parent:this,bridge:e,localdb:this.localdb}),this.#localProvider.on("items.changed",this.#listenItems),this.localProvider.init()}#listenItems=async()=>{this.localdb&&(this.items=await this.#loadManager.processEntries(this.#localProvider.items),this.trigger("change"))};setOffline=e=>this.localProvider.setOffline(e);setItems(e){this.items=e}async store(){return await this.#localProvider.init(),this.#localProvider.store}async set(e){var t=e.items;delete e.item,await super.set(e),t.forEach(e=>{e.id&&this.#elements.set(e.id,e)})}#clear(){this.items=[]}async delete(e){try{this.#localProvider&&await this.#localProvider.softDelete(e),this.provider&&await this.provider.deleteItems(e)}catch(e){console.error(e)}}load(e){return this.#loadManager.load(e)}localLoad(e){return this.#loadManager.localLoad(e)}filter=e=>this.#loadManager.filter(e);save=(e,t)=>this.#saveManager.save(e,t);sync=e=>this.#saveManager.sync(e);publish=e=>this.#saveManager.publish(e);toSync=()=>this.#saveManager.toSync();async setEntries(e){return await this.save(e,!0),(e=await this.#loadManager.processEntries(e,!0)).forEach(e=>this.#elements.set(e.id,e)),this.items=e,this.trigger("change"),e}}t.Collection=n}}),c.set("./collection/interfaces/children-constructor-props",{hash:251458602,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}}),c.set("./collection/interfaces/collection",{hash:1873156359,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}}),c.set("./collection/load",{hash:1757290950,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CollectionLoadManager=void 0;var r=e("../registry/factory");t.CollectionLoadManager=class{filter;#localProvider;#provider;#loaded=new Map;#parentBridge;#parent;#registry;#adapter;#localdb;#localIds=new Set;get parent(){return this.#parent}remoteData=[];constructor({parent:e,bridge:t,localdb:r}){this.#parent=e,this.#parentBridge=t,this.#localdb=r,this.#adapter=this.#parent.responseAdapter,this.init()}init(){this.#localProvider=this.#parentBridge.get("localProvider"),this.#provider=this.#parentBridge.get("provider"),this.#registry=r.RegistryFactory.get(this.#parentBridge.get("storeName"))}#localLoad=async e=>{var t,r;if(this.#localProvider)return t=await this.#localProvider.load(e)??{data:[]},r=await this.processEntries(t.data),(e=!0===e.update?this.parent.items.concat(r):r).forEach(e=>this.#localIds.add(e.id)),r={localLoaded:!0,fetching:!1,total:t.total??0,next:!!t.next,items:e},t.next&&(r.next=t.next),this.#parent.loaded=!0,this.parent.set(r),this.#adapter.toClient({data:e})};#page=1;#remoteElements=[];localLoad=async(e={})=>{try{return this.#localLoad(e)}catch(e){console.error(e)}};load=async(e={})=>{try{this.#parent.fetching=!0;var t=this.parent.next,{start:r=0,update:i}=e;if(e.limit=e.limit??30,r=!0===i&&t?t:r,i&&(this.#page++,e.start=r),this.#parentBridge.get("localdb")){var s=await this.#localLoad(e);if(!this.#parent.isOnline||!this.#provider)return s}var{properties:a,items:o}=await this.#remoteLoad(e);return this.parent.set(a),this.parent.triggerEvent(),this.#adapter.toClient({data:o})}catch(e){return this.parent.triggerEvent(),console.error(e),this.#adapter.toClient({error:e})}finally{this.#parent.fetching=!1,this.#parent.fetched=!0,this.#parent.landed=!0}};#remoteLoad=async e=>{var t=await this.#provider.list(e),r=this.#adapter.fromRemote(t).data,i=await this.processRemoteEntries(r);this.remoteData=t,this.#remoteElements=!0===e.update?this.#remoteElements.concat(i):i;const s=this.#remoteElements.map(e=>e.id);return(t=[...this.#localIds].filter(e=>!s.includes(e))).length&&this.#localProvider.deleteItems(t),t.forEach(e=>this.#parent.elements.delete(e)),this.#localIds=new Set(s),{properties:e={items:this.#remoteElements,next:r.next,loaded:!0,fetching:!1,total:r.total||0},items:i}};async processRemoteEntries(e){var t;if(e.entries?.length||(this.#parentBridge.clear(),this.parent.triggerEvent()),e.entries||e.items)return t=e.items||e.entries,e.deletedEntries&&this.#localProvider.softDelete(e.deletedEntries),this.#localdb&&await this.#localProvider.save(t),this.processEntries(t);throw new Error("The list method must return an object with an entries property")}processEntries=async(s,a=!1)=>{const o=[];var e=s.map(e=>{if(this.#loaded.has(e.id)){const i=this.#loaded.get(e.id);return o.push(i.isReady),i}var t={id:e.id,...e};a&&(t.properties=e);const r=s.map(e=>e.id),i=([...this.#parent.elements.values()].filter(e=>!r.includes(e.id)).forEach(e=>{this.#parent.elements.delete(e)}),new this.parent.item(t));return o.push(i.isReady),this.#loaded.set(e.id,i),i});return await Promise.all(o),e.forEach((e,t)=>{e.set(s[t],a)}),e};remoteLoad=async e=>{if((e=await this.#provider.load(e)).status)return e.data;throw e.error}}}}),c.set("./collection/local-provider/index",{hash:1571441587,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CollectionLocalProvider=void 0;var r=e("@beyond-js/reactive/model"),i=e("@beyond-js/kernel/core"),s=e("@beyond-js/reactive/database"),a=e("../../registry/factory"),o=e("./saver"),n=e("./loader");class l extends r.ReactiveModel{#isOnline=globalThis.navigator.onLine;#offline;#database;#storeName;#databaseName;#loadManager;#exists=!1;#found=!1;#db;#registryFactory;#parent;#saveManager;#localdb;#store;get store(){return this.#store}#apply=!0;get apply(){return this.#apply}#active;get active(){return this.#active}#items=[];get items(){return this.#items}#setItems=e=>{this.#items=e};get isOnline(){return this.#isOnline&&!this.#offline&&!localStorage.getItem("reactive.offline")}constructor(e,t){super();var{db:r,storeName:i}=e;this.#parent=e,this.localdb=t.get("localdb"),this.localdb?(r&&(this.#registryFactory=a.RegistryFactory.get(r)),this.#databaseName=r,this.#storeName=i,globalThis.addEventListener("online",this.handleConnection),globalThis.addEventListener("offline",this.handleConnection),this.#loadManager=new n.LocalProviderLoader(this,{store:this.#store,setItems:this.#setItems})):this.#apply=!1}setOffline(e){this.#offline=e,this.triggerEvent()}#promiseInit;init=async()=>{try{if(this.#apply){if(this.#promiseInit)return this.#promiseInit;if(this.#promiseInit=new i.PendingPromise,this.#databaseName&&this.#storeName){var e=await s.DBManager.get(this.#databaseName);if(this.#database=e,this.#store=e.db[this.#storeName],!this.#store)throw new Error(`The store ${this.#storeName} does not exists in the database `+this.#databaseName);this.#saveManager=new o.LocalProviderSaver(this,{registryFactory:this.#registryFactory,storeName:this.#storeName,database:this.#database}),this.ready=!0}else this.#active=!1;this.#promiseInit.resolve()}else this.ready=!0}catch(e){console.error(e)}};handleConnection=()=>this.triggerEvent();async upsert(e,t){if(this.#apply)return this.#database.db.transaction("rw",this.store,async()=>{const t=new Map;e.forEach(e=>{t.set(e.instanceId,e.id)}),await this.store.bulkPut(e)})}async softDelete(e){if(this.#apply){if(!Array.isArray(e))return console.error("Expected an array of items for soft deletion"),{status:!1,data:[]};try{var t,r=(await this.store.bulkGet(e)).filter(e=>void 0!==e);if(r.length)return t=r.map(e=>({...e,isDeleted:1})),await this.#store.bulkPut(t),!0}catch(e){return console.error("Error occurred while performing a soft delete:",e),{status:!1,error:e.message}}}}async deleteItems(e){if(this.#apply&&this.#localdb)try{await this.store.bulkDelete(e)}catch(e){console.error("Failed to delete items:",e)}}save=e=>this.#saveManager.save(e);saveAll=(e,t)=>this.#saveManager.saveAll(e,t);load=e=>this.#loadManager.load(e)}t.CollectionLocalProvider=l}}),c.set("./collection/local-provider/loader",{hash:588579742,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.LocalProviderLoader=void 0;var r=e("@beyond-js/kernel/core"),s=e("dexie");t.LocalProviderLoader=class{#parent;#promiseLoad;#params;#listItems=new Map;#total;#page=0;#ids=new Set;#conditions=["or"];#setItems;#customWhere;#defaultWhere=e=>e.orderBy("id");#currentLimit;#currentOffset;constructor(e,t){this.#parent=e,this.#setItems=t.setItems}#quantity=0;async load(e){if(this.#parent.apply)return JSON.stringify(this.#params)===JSON.stringify(e)||this.#promiseLoad?this.#promiseLoad:(this.#promiseLoad=new r.PendingPromise,await this.#parent.init(),this.#performLoad(e))}async#performLoad(e){try{this.#total||(this.#total=await this.#parent.store.count());var t,r=e.limit??30,i=Math.ceil(this.#total/r);if(!(i<this.#page))return t=(0,s.liveQuery)(this.where(e,r)),this.#page++,this.#subscribeToQuery(t,e,i);this.#resolvePromiseLoad()}catch(e){return console.error("Error al cargar los elementos del store:",e),{status:!1,data:[]}}}where=(o,n)=>async()=>{var e=this.#parent.store,t=o.sortBy,r=(this.#page-1)*n;let i={...o};i.hasOwnProperty("where")&&delete(i={...i,...i.where}).where;const s=e.schema.indexes.map(e=>e.name);Object.keys(i).forEach(e=>{s.includes(e)||delete i[e]});let a=0===Object.keys(i).length?e:e.where(i);return this.#currentLimit=n,this.#currentOffset=r,t&&await a.sortBy(t),(a=a.filter(e=>1!==e.isDeleted)).offset(r).limit(n).toArray()};customFilter=e=>(this.#customWhere=e,this.#parent);async#subscribeToQuery(e,t,r){return e.subscribe({next:async e=>{e=await this.#handleQueryResponse(e,t,r,void 0),this.#resolvePromiseLoad(e)},error:e=>{console.error(e),this.#resolvePromiseLoad({status:!1,data:[]})}}),this.#promiseLoad}async#handleQueryResponse(e,r,t,i){let s;if(this.#quantity++,r.sortBy&&e.sort((e,t)=>e[r.sortBy]-t[r.sortBy]),globalThis.data||(globalThis.data=[]),i===this.#page?s=!0:i=this.#page,!s||e.length!==this.#parent.items.length){const a=new Set;return e.forEach(e=>{this.#listItems.set(e.id,e),a.add(e.id)}),this.#cleanupItems(a),this.#setItems([...this.#listItems.values()]),e.forEach(e=>this.#ids.add(e.id)),this.#parent.trigger("items.changed"),this.#parent.trigger("change"),{status:!0,data:e,total:this.#total,next:!(this.#page+1>=t)||void 0}}}#cleanupItems(t){[...this.#listItems.keys()].forEach(e=>{t.has(e)||this.#listItems.delete(e)})}#resolvePromiseLoad(e={}){this.#promiseLoad&&(this.#promiseLoad.resolve(e),this.#promiseLoad=null)}}}}),c.set("./collection/local-provider/saver",{hash:3271791775,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.LocalProviderSaver=void 0;var l=e("../../registry");t.LocalProviderSaver=class{#batches=200;#parent;#registryFactory;#storeName;#database;constructor(e,t){this.#parent=e,this.#registryFactory=t.registryFactory,this.#storeName=t.storeName,this.#database=t.database}async save(e){var t=e,r=this.#parent.isOnline?0:1;e=t.map(e=>({...e.getProperties&&"function"==typeof e.getProperties?e.getProperties():e,offline:r,instanceId:e.instanceId})),this.#parent.apply&&(await this.#registryFactory.init(),await this.saveAll(e,this.#storeName))}async saveAll(e,r){if(this.#parent.apply){var t=e.map(e=>{var t=new l.Registry(r);return e.deleted&&(t.isDeleted=!0),t.setValues(e),t}),i=this.#database.db[r],s=[];const n=[];for(;0<t.length;){var a=t.splice(0,this.#batches).map(e=>e.getValues());n.push(a),s.push(i.bulkPut(a))}try{var o=(await Promise.allSettled(s)).map((e,t)=>({...e,index:t,data:n[t]})).filter(e=>"rejected"===e.status);return o.length?{status:!1,failed:o}:{status:!0}}catch(e){return{status:!1,failed:e}}}}}}}),c.set("./collection/publish",{hash:190812589,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CollectionSaveManager=void 0,t.CollectionSaveManager=class{#parent;#bridge;#localProvider;#provider;#localdb;MAX_RETRIES=3;CHUNK_SIZE=200;#adapter;constructor(e,t){this.#parent=e,this.#bridge=t,this.#adapter=this.#parent.responseAdapter,this.init()}init(){this.#localdb=this.#bridge.get("localdb"),this.#localdb&&(this.#localProvider=this.#bridge.get("localProvider")),this.#provider=this.#bridge.get("provider")}save=async(e=[],t)=>{if(!this.#localdb)return!0;console.log(.2,this,this.#localdb,this.#parent),await this.#localProvider.init(),await this.#localProvider.save(e)};publish=async(e=[])=>{try{if(await this.save(e),this.#provider&&!this.#bridge.get("isOffline")){var t=await this.#provider.bulkSave(e);if(t.status)return this.#adapter.toClient({status:!0});throw t.error}}catch(e){return console.error(e),this.#adapter.toClient({error:e})}};sendChunk=async e=>{var t,r=await this.#provider.bulkSave(e);return r.status?(t=r.data.entries.map(e=>({...e,offline:0,instanceId:void 0})),await this.#localProvider.upsert(t,e),{success:!0,chunk:e,response:r}):{success:!1,chunk:e,response:r}};splitDataIntoChunks=t=>{var r=[];for(let e=0;e<t.length;e+=this.CHUNK_SIZE)r.push(t.slice(e,e+this.CHUNK_SIZE));return r};sync=async e=>{await this.#localProvider.init(),e=e||await this.#parent.localProvider.store.where("offline").equals(1).toArray();var t,r=[],i=[];for([,t]of(e=this.splitDataIntoChunks(e)).entries()){var s=await this.sendChunk(t);(s.success?i:r).push(s)}return this.#bridge.set("items",[]),await this.#parent.load(),r.length?(e=r.length===e.length?"FAILED_SYNC":"INCOMPLETE_SYNC",this.#adapter.toClient({data:{failed:r,success:i,error:e}})):this.#adapter.toClient({data:i})};toSync=async()=>{try{return await this.#localProvider.init(),this.#localProvider.store.where("offline").equals(1).toArray()}catch(e){console.error(e)}}}}}),c.set("./example/collection",{hash:3039560133,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}}),c.set("./example/index",{hash:1295999388,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Book=void 0;class r extends e("../item/index").Item{properties=["id","title","author","year"];constructor({id:e=void 0}={}){super({id:e,storeName:"book",db:"test"})}}t.Book=r}}),c.set("./interfaces/provider",{hash:3424040814,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}}),c.set("./item/index",{hash:1228119537,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Item=void 0;var r=e("@beyond-js/reactive/model"),i=e("./local-provider"),s=e("./save"),a=e("./load"),o=e("@beyond-js/kernel/core"),n=e("../adapter");class l extends r.ReactiveModel{id;localdb;#provider;storeName;db;localFields=[];#localData;#skeleton=[];localProvider;unique=[];#saveManager;get skeleton(){return this.#skeleton}__get(e){return this[e]}get provider(){return this.#provider}#isDeleted=0;get isDeleted(){return!!this.#isDeleted}get store(){return this.localProvider.store}get isOnline(){return this.localProvider.isOnline&&!localStorage.getItem("reactive.offline")}get __instanceId(){return this.localProvider.__instanceId}get isReady(){if("function"==typeof this.checkReady)return this.checkReady();console.warn("is not a function",this.checkReady,this.constructor.name)}#loadManager;#objectReady=!1;#promiseReady;#initPromise;#config;#responseAdapter;get responseAdapter(){return this.#responseAdapter}constructor(e={}){super(e?.properties?{properties:e.properties}:{});var{db:t,storeName:r,localdb:i}=e;if(this.#config=e,this.#responseAdapter=n.ResponseAdapter.get(this,this.#config?.adapter),t&&(this.db=t),r&&(this.storeName=r),this.localdb=i||!(!t||!r),e.provider){if("function"!=typeof e.provider)throw new Error("Provider must be an function");this.#provider=new e.provider(this)}this.#start(e),this.on("object.loaded",this.checkReady)}#start(e){this.reactiveProps(["found","landed"]),this.save=this.save.bind(this),this.checkReady=this.checkReady.bind(this);var t={parent:this,bridge:{get:e=>this.__get(e),set:(e,t)=>this[e]=t},localdb:this.localdb};this.localProvider=new i.LocalProvider(t),this.#saveManager=new s.ItemSaveManager(t),this.#loadManager=new a.ItemLoadManager(t),this.init(e)}async initialise(){this.init(this.#config)}checkReady(){return this.ready||(this.#promiseReady||(this.#promiseReady=new o.PendingPromise,this.objectReady&&this.#promiseReady.resolve(this.#objectReady),this.on("object.loaded",()=>{this.#objectReady=!0,this.#promiseReady.resolve(this.#objectReady)})),this.#promiseReady)}async init(t){try{let e;if(this.#initPromise)return this.#initPromise;this.#initPromise=new o.PendingPromise,t.id&&(e=t.id),this.id=t.id,this.localdb&&(await this.localProvider.init(e),this.set(this.localProvider.registry.values)),this.#skeleton&&0<this.#skeleton.length&&(this.properties=this.#skeleton),t.properties&&this.set(t.properties,!0),this.ready=!0,this.#initPromise.resolve(!0),this.trigger("object.loaded")}catch(e){console.error("error initializing",e)}}setOffline=e=>this.localProvider.setOffline(e);async set(t,e=!1){"object"!=typeof t&&console.trace(t),e||await this.isReady,e&&this.localdb&&(this.#localData=new Map(Object.entries(t)),this.localProvider.save(t)),this.properties?.forEach(e=>{"object"==typeof e?t.hasOwnProperty(e.name):t.hasOwnProperty(e)&&(this[e]=t[e])}),this.triggerEvent()}getValues(){const t={};return(this.skeleton.length?this.skeleton:this.properties).forEach(e=>{this.hasOwnProperty(e)&&(t[e]=this[e])}),t}getPropertyNames(){return this.properties}save(e){return this.#saveManager.save(e)}sync(){return this.#saveManager.sync()}forceSync(){return this.#saveManager.forceSync()}publish(e){return this.#saveManager.publish(e)}load(e){return this.#loadManager.load(e)}async delete(){try{return this.#isDeleted=1,this.localProvider&&await this.localProvider.delete(),this.provider&&await this.provider.delete(this.id),this.triggerEvent(),!0}catch(e){console.error("error",e)}}}t.Item=l}}),c.set("./item/interfaces/config",{hash:306116134,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}}),c.set("./item/interfaces/item",{hash:3620101475,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}}),c.set("./item/load",{hash:1916940339,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ItemLoadManager=void 0,t.ItemLoadManager=class{#parent;#localProvider;#provider;#getProperty;#bridge;#adapter;#localdb;ready;constructor({parent:e,bridge:t,localdb:r}){this.#parent=e,this.#getProperty=t.get,this.#bridge=t,this.#localdb=r,this.#adapter=this.#parent.responseAdapter,this.init()}init=()=>{this.#localProvider=this.#getProperty("localProvider"),this.#provider=this.#getProperty("provider"),this.ready=!0};load=async e=>{try{await this.#getProperty("checkReady")(),e=e||{id:this.#parent.id};var t,r=await this.#getProperty("localdb");const a=this.#getProperty("localProvider");if(!e&&this.#parent.id&&(e={id:this.#parent.id}),r&&a&&(t=await a.load(e))?.status&&(this.#parent.set(t.data,!0),t.data.__instanceId&&(this.#localProvider.__instanceId=t.data.__instanceId),this.#localProvider.__instanceId||(this.#localProvider.__instanceId=this.#localProvider.registry.__instanceId)),a&&!a.isOnline)return{status:!0};if(this.#provider){var i,s=await this.remoteLoad(e);const o=s?.data;if(o){if(this.#parent.found=!0,this.#parent.fetched=!0,this.#parent.set(o),r){let t=!0;this.#parent.landed=!0,Object.keys(o).forEach(e=>{a.registry.values[e]!==o[e]&&(t=!1)}),t||(i=isNaN(this.#parent.id)?this.#parent.id:parseInt(this.#parent.id),await this.#localProvider.save({...this.#parent.getProperties(),...o,id:i,__instanceId:this.#localProvider.__instanceId}))}}else this.#parent.found=!1;return this.#adapter.toClient(s)}}catch(e){throw e}finally{this.#parent.fetching=!1}};remoteLoad=async e=>{try{if(this.#parent.isOnline){var t,r=(this.#provider.data||this.#provider.load).bind(this.#provider);if("function"==typeof r)return t=await r(e),this.#adapter.fromRemote(t);console.error("The provider object is not defined correctly. It must have a data method")}}catch(e){this.#parent.found=!1,this.#parent.fetching=!1}}}}}),c.set("./item/local-provider",{hash:2040082601,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.LocalProvider=void 0;var r=e("@beyond-js/reactive/model"),i=e("@beyond-js/reactive/database"),a=e("../registry/factory");class s extends r.ReactiveModel{#isOnline=globalThis.navigator.onLine;#store;#offline;#isNew=!1;#database;#storeName;#databaseName;#originalData;#exists=!1;get store(){return this.#store}__instanceId;get originalData(){return this.#originalData}#db;get isOnline(){return this.#isOnline&&!this.#offline&&!localStorage.getItem("reactive.offline")}#parent;#getProperty;#factoryRegistry;#registry;#localdb;get localdb(){return this.#parent.localdb}#bridge;get registry(){return this.#registry}#apply;constructor({parent:e,bridge:t,localdb:r}){super(),this.#getProperty=t.get;var{db:i,storeName:s}=e;this.__id=Math.floor(99001*Math.random())+1e3,this.#parent=e,this.#apply=i&&s,this.#databaseName=i,this.#storeName=s,this.#bridge=t,this.#localdb=r,this.#factoryRegistry=a.RegistryFactory.get(i,this.#localdb),this.load=this.load.bind(this)}setOffline(e){this.#offline=e,this.triggerEvent()}init=async(e=void 0)=>{try{var t;return this.#localdb&&(t=await i.DBManager.get(this.#databaseName),this.#database=t,this.#store=t.db[this.#storeName]),this.#isNew=!!e,this.#getRegistry(e)}catch(e){console.error(e)}};deepCompare(e,t){var r,i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(r of i){var a=e[r],o=t[r],n=this.isObject(a)&&this.isObject(o);if(n&&!this.deepCompare(a,o)||!n&&a!==o)return!1}return!0}isObject(e){return null!=e&&"object"==typeof e}#isUnpublished(e){Object.keys(e);var t={...this.#registry.values};return!this.deepCompare(t,e)}async load(e={}){try{var t;if(t=e.id??this.registry.values?.id)return await this.#getRegistry(t),this.#parent.localLoaded=!0,this.#parent.set(this.#registry.values),{status:!0,data:this.#registry.values};throw"ID IS REQUIRED"}catch(e){return console.error(e),e}}#getRegistry=async e=>{var t=await this.#factoryRegistry.get(this.#storeName,e);let r={id:e},i=!!t;if(!i)return!t&&this.localdb&&e&&((e=await this.#store.get(e))&&(r=e),i=!0),i&&(this.#parent.found=i,this.#parent.loaded=!0),t=this.#factoryRegistry.create(this.#storeName,r),this.#registry=t,this.#registry.on("change",this.#listenRegistry.bind(this)),this.#isNew=!!this.#registry?.values?.isNew,this.#registry.values;this.#parent.set(t.values),i=!0,this.#registry=t,this.#registry.on("change",this.#listenRegistry.bind(this)),this.#isNew=!!this.#registry?.values?.isNew};#listenRegistry(){this.#parent.set(this.#registry.values)}async save(e){try{var t;if(this.#isUnpublished(e))return e.offline=this.isOnline?0:1,e.isNew=this.#isNew?1:0,(t=await this.validateUniqueFields(e)).length?{error:"duplicated",fields:t}:(await this.#update(e),this)}catch(e){console.error("error saving",e.message)}}async validateUniqueFields(e){var t;return this.localdb&&this.#getProperty("unique").length?(t=this.#getProperty("unique").map(t=>this.#store.where(t).equals(e[t]).count().then(e=>e?t:null)),(await Promise.all(t)).filter(e=>null!==e)):[]}delete=async()=>{if(this.#database)return this.deleteRegistry(this.#registry.values.id)};deleteRegistry=async e=>(await this.#database.db[this.#storeName].delete(e),this.triggerEvent(),!0);isPlainObject(e){if("object"!=typeof e||null===e)return!1;for(const t in e)if("function"==typeof e[t])return!1;return!0}async#delete(e){return await this.#database.db[this.#storeName].delete(e.id),!0}async#update(e){if(this.#registry.setValues(e)){var t=this.#database.db[this.#storeName];if(this.isPlainObject(e))return await t.put({...this.#registry.values,...e}),this.triggerEvent(),!0;throw console.warn("Data needs to be a plain object to be saved",e),new Error("Data needs to be a plain object to be saved")}}}t.LocalProvider=s}}),c.set("./item/save",{hash:1763458845,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ItemSaveManager=void 0,t.ItemSaveManager=class{#parent;#getProperty;#bridge;#provider;#localProvider;#localdb;#adapter;constructor({parent:e,bridge:t,localdb:r}){this.#parent=e,this.#getProperty=t.get,this.#bridge=t,this.#localdb=r,this.#adapter=this.#parent.responseAdapter,this.init()}init(){this.#parent.localUpdate=this.localUpdate,this.#localProvider=this.#getProperty("localProvider"),this.#provider=this.#getProperty("provider")}save=async t=>{if(await this.#getProperty("checkReady")(),t&&await this.#parent.set(t),this.#parent.isUnpublished){var r,t={...t,...this.#parent.getProperties()};let e;return this.#parent.isOnline&&this.#provider?(r=await this.#publish(t),e=this.#adapter.fromRemote(r),this.#localdb&&(this.#localProvider.registry.setValues(r.data),t.id=r?.data?.id,this.#localProvider.registry.isNew=!1,await this.#localProvider.save(t))):this.#localProvider&&await this.#localProvider.save(t),this.#parent.triggerEvent(),this.#adapter.toClient(e)}};publish=this.save;#publish=async e=>{try{if(this.#provider&&this.#bridge.get("isOnline")){let t={...e};this.#parent.localFields.forEach(e=>{delete t[e]});var r=await this.#provider.publish(t),i=this.#adapter.fromRemote(r).data;return await this.#parent.set(i),this.#localProvider&&this.#localdb&&(this.#localProvider.save(i),t.id===this.#localProvider.registry.__instanceId&&this.#localProvider.deleteRegistry(t.id),this.#localProvider.trigger("change")),this.#adapter.toClient(r)}}catch(e){return console.error("ERROR PUBLISHING",e),this.#adapter.toClient({error:e})}};sync=()=>{var e=this.#getProperty("localProvider");e.registry.values.offline?this.#publish(e.registry.values):console.warn("registry already synced")};forceSync(){const t={...this.#getProperty("localProvider").registry.values};this.#parent.localFields.forEach(e=>{delete t[e]}),this.#provider.publish(t)}localUpdate=async(e=void 0)=>{try{await this.#getProperty("checkReady")(),e&&this.#parent.set(e);var t=this.#parent.getProperties();return this.#localdb&&await this.#localProvider.save(t),this.#parent.triggerEvent(),this.#adapter.toClient()}catch(e){console.error("error updating locally",e)}}}}}),c.set("./providers/collection",{hash:1203865910,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CollectionProvider=void 0,t.CollectionProvider=class{list(e){}publish(e){}load(e){}}}}),c.set("./providers/item",{hash:632847434,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ItemProvider=void 0,t.ItemProvider=class{delete(e){}publish(e){}load(e){}}}}),c.set("./registry/factory",{hash:2312446295,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.RegistryFactory=void 0;var r=e("@beyond-js/reactive/model"),i=e("./index"),s=e("@beyond-js/kernel/core");class a extends r.ReactiveModel{#stores=new Map;#dbName;#localdb;constructor(e,t=!0){super(),this.#dbName=e,this.#localdb=t,this.init()}#promiseReady;async init(){return!!this.ready||this.#promiseReady||(this.#promiseReady=new s.PendingPromise,this.#promiseReady.resolve(),this.#promiseReady=void 0,void(this.ready=!0))}registerList(t,e){e.map(e=>this.hasItem(t,e.id)?this.getItem(t,e.id):this.create(t,e))}hasItem(e,t){return this.#stores.has(e)&&this.#stores.get(e).has(t)}getItem(e,t){if(this.hasItem(e,t))return this.#stores.get(e).get(t);throw new Error(`Item ${t} does not exists in store `+e)}#getStore(e){return this.#stores.has(e)||this.#stores.set(e,new Map),this.#stores.get(e)}create(e,t){var r=new i.Registry(e,t);return r.setValues(t),this.#getStore(e).set(r.values.id,r),r}async get(e,t=void 0){if(this.#stores.has(e)||this.#stores.set(e,new Map),this.#stores.has(e)&&this.#stores.get(e).has(t))return this.#stores.get(e).get(t)}async has(e,t){if(this.#stores.has(e)&&this.#stores.get(e).has(t))return!0}static#dbs=new Map;static get(e,t){return this.#dbs.has(e)?this.#dbs.get(e):(t=new a(e,t),this.#dbs.set(e,t),t)}}t.RegistryFactory=a}}),c.set("./registry/index",{hash:738374833,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Registry=void 0;var r=e("@beyond-js/reactive/model"),i=e("uuid");class s extends r.ReactiveModel{#values={};get values(){return this.#values}#id;#store;#isDeleted;#isNew;__instanceId;get isNew(){return this.#isNew}set isNew(e){this.#isNew=e,this.triggerEvent()}#keyId;get isDeleted(){return this.#isDeleted}set isDeleted(e){e!==this.#isDeleted&&(this.#isDeleted=e,this.triggerEvent())}constructor(e,t={id:void 0}){super();var r=t.id;this.#store=e,this.#isNew=void 0===r,this.#id=r,this.__instanceId=t.__instanceId??(0,i.v4)(),r||(this.#id=this.__instanceId),this.#id&&(this.#values.id=this.#id)}setValues=r=>{if(r){var e=Object.keys(r);let t=!1;r.id||(r.id=this.#id);const i={...this.#values};return e.forEach(e=>{r[e]!==i[e]&&(i[e]=r[e],t=!0)}),r.__instanceId&&(this.__instanceId=r.instanceId),i.isDeleleted=1===this.isDeleted??0,this.#values=i,this.triggerEvent(),t}};getValues(){var e={...this.#values};return this.__instanceId&&(e.__instanceId=this.__instanceId),e}}t.Registry=s}}),c.set("./registry/store",{hash:51750468,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.StoreRecords=void 0;class r extends e("@beyond-js/reactive/model").ReactiveModel{}new(t.StoreRecords=r)}}),h.exports.descriptor=[{im:"./adapter/index",from:"TCustomAdapter",name:"TCustomAdapter"},{im:"./adapter/index",from:"IConfig",name:"IConfig"},{im:"./adapter/interface",from:"IResponseAdapter",name:"IResponseAdapter"},{im:"./collection/index",from:"Collection",name:"Collection"},{im:"./collection/local-provider/index",from:"CollectionLocalProvider",name:"CollectionLocalProvider"},{im:"./example/index",from:"Book",name:"Book"},{im:"./interfaces/provider",from:"IProvider",name:"IProvider"},{im:"./item/index",from:"Item",name:"Item"},{im:"./item/interfaces/item",from:"IItem",name:"IItem"},{im:"./item/local-provider",from:"LocalProvider",name:"LocalProvider"},{im:"./providers/collection",from:"CollectionProvider",name:"CollectionProvider"},{im:"./providers/item",from:"ItemProvider",name:"ItemProvider"},{im:"./registry/factory",from:"RegistryFactory",name:"RegistryFactory"},{im:"./registry/store",from:"StoreRecords",name:"StoreRecords"}],h.exports.process=function({require:e,prop:t,value:r}){!e&&"TCustomAdapter"!==t||i("TCustomAdapter",e?e("./adapter/index").TCustomAdapter:r),!e&&"IConfig"!==t||i("IConfig",e?e("./adapter/index").IConfig:r),!e&&"IResponseAdapter"!==t||i("IResponseAdapter",e?e("./adapter/interface").IResponseAdapter:r),!e&&"Collection"!==t||i("Collection",e?e("./collection/index").Collection:r),!e&&"CollectionLocalProvider"!==t||i("CollectionLocalProvider",e?e("./collection/local-provider/index").CollectionLocalProvider:r),!e&&"Book"!==t||i("Book",e?e("./example/index").Book:r),!e&&"IProvider"!==t||i("IProvider",e?e("./interfaces/provider").IProvider:r),!e&&"Item"!==t||i("Item",e?e("./item/index").Item:r),!e&&"IItem"!==t||i("IItem",e?e("./item/interfaces/item").IItem:r),!e&&"LocalProvider"!==t||i("LocalProvider",e?e("./item/local-provider").LocalProvider:r),!e&&"CollectionProvider"!==t||i("CollectionProvider",e?e("./providers/collection").CollectionProvider:r),!e&&"ItemProvider"!==t||i("ItemProvider",e?e("./providers/item").ItemProvider:r),!e&&"RegistryFactory"!==t||i("RegistryFactory",e?e("./registry/factory").RegistryFactory:r),!e&&"StoreRecords"!==t||i("StoreRecords",e?e("./registry/store").StoreRecords:r)},i("__beyond_pkg",h),i("hmr",new function(){this.on=(e,t)=>h.hmr.on(e,t),this.off=(e,t)=>h.hmr.off(e,t)}),h.initialise(c)}}});