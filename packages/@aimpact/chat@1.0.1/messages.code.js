System.register(["@beyond-js/kernel@0.1.9/bundle","react@18.2.0","pragmate-ui@0.1.1/icons","@aimpact/chat@1.0.1/shared/icons","pragmate-ui@0.1.1/empty","@beyond-js/react-18-widgets@1.1.2/hooks","pragmate-ui@0.1.1/toast","@aimpact/chat-sdk@1.0.0/session","@aimpact/chat-sdk@1.0.0/widgets/playable","@aimpact/media-manager@1.0.0/audio-player","pragmate-ui@0.1.1/components","@aimpact/chat-sdk@1.0.0/widgets/markdown","pragmate-ui@0.1.1/collapsible","@beyond-js/kernel@0.1.9/styles"],function(s,e){"use strict";var t,a,n,r,o,c,l,i,u,d,m,p,f,g,h,y;return s("Messages",void 0),{setters:[function(e){t=e},function(e){a=e},function(e){n=e},function(e){r=e},function(e){o=e},function(e){c=e},function(e){l=e},function(e){i=e},function(e){u=e},function(e){d=e},function(e){m=e},function(e){p=e},function(e){f=e},function(e){g=e}],execute:function(){y=t.Bundle,(h=new y({module:{vspecifier:"@aimpact/chat@1.0.1/messages",multibundle:!0},type:"code"},e.meta.url).package()).dependencies.update([["react",a],["pragmate-ui/icons",n],["@aimpact/chat/shared/icons",r],["pragmate-ui/empty",o],["@beyond-js/react-18-widgets/hooks",c],["pragmate-ui/toast",l],["@aimpact/chat-sdk/session",i],["@aimpact/chat-sdk/widgets/playable",u],["@aimpact/media-manager/audio-player",d],["pragmate-ui/components",m],["@aimpact/chat-sdk/widgets/markdown",p],["pragmate-ui/collapsible",f],["@beyond-js/kernel/styles",g]]),brequire("@beyond-js/kernel/styles").styles.register("@aimpact/chat@1.0.1/messages.code"),(y=new Map).set("./answering",{hash:585936996,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.SystemAnswering=void 0;var a=e("react"),s=e("pragmate-ui/icons"),n=e("@aimpact/chat/shared/icons");t.SystemAnswering=()=>a.default.createElement("div",{className:"message answering"},a.default.createElement(s.Icon,{className:"lg",icon:n.ICONS["ai-profile"]}),a.default.createElement("div",{className:""},a.default.createElement("span",{className:"dot"}),a.default.createElement("span",{className:"dot"}),a.default.createElement("span",{className:"dot"})))}}),y.set("./context",{hash:1383344350,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.useChatMessagesContext=t.ChatMessagesContext=void 0;var a=e("react");const s=t.ChatMessagesContext=a.default.createContext({});t.useChatMessagesContext=()=>a.default.useContext(s)}}),y.set("./index",{hash:1667957409,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Messages=function({chat:e,player:t,messages:a,texts:s,current:n}){var r,[n,o]=c.default.useState(n);return a.length?(r=a.map((e,t)=>c.default.createElement(l.Message,{key:"message-"+t,message:e})),c.default.createElement(u.ChatMessagesContext.Provider,{value:e={chat:e,player:t,messages:a,texts:s,currentMessage:n,setCurrentMessage:o}},c.default.createElement("div",{className:"messages__list"},r))):c.default.createElement(i.Empty,{text:s.empty})};var c=e("react"),l=e("./message"),i=e("pragmate-ui/empty"),u=e("./context")}}),y.set("./message/actions/index",{hash:61955387,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.MessageActions=function({text:t,message:a,messageTokens:e,play:s=!0}){const{player:n,currentMessage:r,setCurrentMessage:o}=(0,E.useChatMessagesContext)(),[c,l]=f.default.useState("stop"),[i,u]=f.default.useState(!1),d=((0,h.useBinder)([n],()=>u(n.speaking)),(0,h.useBinder)([n],()=>{u(!1),l("")},"on.finish"),r?.id===a?.id&&i),m=d||"play"===c?"stop":"play",p=d||"play"===c?async({})=>{await n.stop(),l("stop"),u(!1)}:async e=>{e.stopPropagation(),o(a),n.positionToCut=0,n.textId=a.id,e=t.replaceAll(/[-\\*_#]+/g,"").trim(),await n.play(e,a.id)};return f.default.createElement("div",null,f.default.createElement("div",{className:"audio__actions"},f.default.createElement(g.IconButton,{onClick:async()=>{await globalThis?.navigator.clipboard.writeText(t),y.toast.success("Message copied to clipboard")},icon:"copy"}),s&&f.default.createElement(g.IconButton,{onClick:p,"data-listen":"api",icon:m})),e&&f.default.createElement("div",{className:"tokens overline"},e," TOKENS"))};var f=e("react"),g=e("pragmate-ui/icons"),h=e("@beyond-js/react-18-widgets/hooks"),y=e("pragmate-ui/toast"),E=e("../../context")}}),y.set("./message/components/profile-icon",{hash:2128465958,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ProfileIcon=function({role:e}){const[t,a]=(0,o.useState)(!1),s="user"===e?"user":globalThis.localStorage.getItem("chat.app.user.default.profile"),n=l.sessionWrapper.user.getProperties(),r="user"===e?n.photoURL:globalThis.localStorage.getItem("chat.app.user.default.profile");return o.default.createElement("picture",{className:"picture__container"},n.photoURL&&!t||"user"!==e?o.default.createElement("img",{alt:"user image profile",src:r,onError:()=>a(!0)}):o.default.createElement(c.Icon,{className:"lg",icon:i.ICONS[s]??s}))};var o=e("react"),c=e("pragmate-ui/icons"),l=e("@aimpact/chat-sdk/session"),i=e("@aimpact/chat/shared/icons")}}),y.set("./message/components/text",{hash:654220471,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.MessageText=function({message:t,playable:e,autoplay:a=!1}){const s=t?.content??"",n=u.default.useRef(null),{texts:r,player:o,currentMessage:c,setCurrentMessage:l}=(0,f.useChatMessagesContext)();var i;return(0,d.useBinder)([o],()=>{n.current.querySelectorAll(".highlight").forEach(e=>e.classList.remove("highlight"))},"on.finish"),"string"!=typeof s?null:(a=t&&"user"!==t.role&&a,i=t.id===c?.id&&a,u.default.createElement("div",{className:"message-text__container p2",ref:n},s&&u.default.createElement(m.Playable,{content:s,autoplay:i&&a,player:o,id:t.id,playable:e,onClickWord:e=>l(t),toolTexts:r.tools}),t.audio&&u.default.createElement(p.AudioPlayer,{src:t.audio,convert:!0})))};var u=e("react"),d=e("@beyond-js/react-18-widgets/hooks"),m=e("@aimpact/chat-sdk/widgets/playable"),p=e("@aimpact/media-manager/audio-player"),f=e("../../context")}}),y.set("./message/index",{hash:3018165614,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Message=function({message:a}){const[,s]=i.default.useState(a?.content??""),[e,n]=i.default.useState(!1),r=(0,g.useChatMessagesContext)().chat,t=(i.default.useEffect(()=>{const e=()=>{n(!0),s(a.content)},t=()=>{s(a.content),n(!1)};return r.on(`message.${a.id}.updated`,e),r.on(`message.${a.id}.ended`,t),()=>{r.off(`message.${a.id}.updated`,e),r.off(`message.${a.id}.ended`,t)}},[]),"message__container "+a.role),o="assistant"===a.role?a.usage?.totalTokens:null,[,c,l]=(0,u.parseText)(a.id,a.content,["transcription","fetching-tool-data","kb-processed-response","function","kb-response"]);return i.default.createElement("div",{className:t,"data-id":a.id},i.default.createElement(p.ProfileIcon,{role:a.role}),i.default.createElement("section",{className:"message__content"},i.default.createElement(f.SystemActions,{actions:l,message:a}),i.default.createElement(d.MessageText,{playable:!0,message:a,fetching:e}),i.default.createElement("section",{className:"message__actions"},i.default.createElement(m.MessageActions,{play:!a.audio,message:a,text:c,messageTokens:o}))))};var i=e("react"),u=e("@aimpact/chat-sdk/widgets/playable"),d=e("./components/text"),m=e("./actions"),p=e("./components/profile-icon"),f=e("./system-actions"),g=e("../context")}}),y.set("./message/system-actions/action",{hash:1180166203,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Action=function({last:s=!1,texts:e,data:{type:n,data:t}}){var a,r=(0,i.useMarked)(),e=e.systemActions,o=({title:e,children:t})=>{var a=s?u.CollapsibleHeader:l.default.Fragment;return l.default.createElement("div",{className:"message-action "+n+(s?" last-action":"")},l.default.createElement(a,null,l.default.createElement("header",null,l.default.createElement("h4",null,e)),l.default.createElement("section",{className:"detail__content"},t)))};if("fetching-tool-data"===n)return l.default.createElement(o,{title:e[n]});if("kb-response"===n)return a=t.matches.map(e=>l.default.createElement("li",{key:e.id},e.paragraph)),l.default.createElement(o,{title:e[n]},l.default.createElement("ul",null,a));if("kb-processed-response"===n)return l.default.createElement(o,{title:e[n]},l.default.createElement("div",{dangerouslySetInnerHTML:{__html:r(t.response)}}));if("transcription"===n)return l.default.createElement(o,{title:e.transcription},l.default.createElement("p",null,t.transcription));if("function"===n&&"kb"===t.name)try{var c=JSON.parse(t.params).text;return l.default.createElement(o,{title:e.functions[t.name]},l.default.createElement("p",null,c))}catch(e){console.error(e)}return l.default.createElement("div",{className:"message-action "+n},n)};var l=e("react"),i=e("@aimpact/chat-sdk/widgets/markdown"),u=e("pragmate-ui/collapsible")}}),y.set("./message/system-actions/index",{hash:2581913566,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.SystemActions=function({actions:e}){if(!e?.length)return null;const a=(0,o.useChatMessagesContext)().texts,t=e[e.length-1];return s.default.createElement("section",{className:"message-actions__container"},s.default.createElement(r.CollapsibleContainer,null,s.default.createElement(n.Action,{data:t,last:!0,texts:a}),s.default.createElement(r.CollapsibleContent,null,s.default.createElement("section",{className:"actions__log"},e.map((e,t)=>s.default.createElement(n.Action,{texts:a,key:"action-"+t,data:e}))))))};var s=e("react"),n=e("./action"),r=e("pragmate-ui/collapsible"),o=e("../../context")}}),h.exports.descriptor=[{im:"./index",from:"Messages",name:"Messages"}],h.exports.process=function({require:e,prop:t,value:a}){!e&&"Messages"!==t||s("Messages",e?e("./index").Messages:a)},s("__beyond_pkg",h),s("hmr",new function(){this.on=(e,t)=>h.hmr.on(e,t),this.off=(e,t)=>h.hmr.off(e,t)}),h.initialise(y)}}});