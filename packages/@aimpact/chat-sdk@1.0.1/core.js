System.register(["@beyond-js/kernel@0.1.9/bundle","@beyond-js/reactive@1.2.0/entities","@aimpact/chat-sdk@1.0.1/api","@aimpact/chat-sdk@1.0.1/config","@aimpact/chat-sdk@1.0.1/session","@aimpact/chat-sdk@1.0.1/startup","@beyond-js/kernel@0.1.9/core"],function(a,e){"use strict";var t,s,i,o,r,n,c,d,h;return a({Audio:void 0,Chats:void 0,IChatProperties:void 0,IChat:void 0,Chat:void 0,Message:void 0,KnowledgeBoxes:void 0,KnowledgeBox:void 0}),{setters:[function(e){t=e},function(e){s=e},function(e){i=e},function(e){o=e},function(e){r=e},function(e){n=e},function(e){c=e}],execute:function(){h=t.Bundle,(d=new h({module:{vspecifier:"@aimpact/chat-sdk@1.0.1/core"},type:"ts"},e.meta.url).package()).dependencies.update([["@beyond-js/reactive/entities",s],["@aimpact/chat-sdk/api",i],["@aimpact/chat-sdk/config",o],["@aimpact/chat-sdk/session",r],["@aimpact/chat-sdk/startup",n],["@beyond-js/kernel/core",c]]),(h=new Map).set("./audio/collection",{hash:253578571,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Audios=void 0;var s=e("@beyond-js/reactive/entities"),a=e("./item");class i extends s.Collection{item=a.Audio;storeName="AudioRecords";db="chat-api";constructor(e){super(e),this.init()}}t.Audios=i}}),h.set("./audio/item",{hash:2422576646,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Audio=void 0;class s extends e("@beyond-js/reactive/entities").Item{properties=["id","userId","category"];constructor({id:e=void 0}={}){super({id:e,db:"chat-api",storeName:"AudioRecords"})}}t.Audio=s}}),h.set("./chats/collection/index",{hash:2314788938,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Chats=void 0;var s=e("@beyond-js/reactive/entities"),a=e("../item"),i=e("./provider");class o extends s.Collection{item=a.Chat;constructor(){super({provider:i.ChatCollectionProvider,storeName:"Chat",db:"chat-api"})}}t.Chats=o}}),h.set("./chats/collection/provider",{hash:2898834084,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ChatCollectionProvider=void 0;var s=e("@aimpact/chat-sdk/api"),a=e("@aimpact/chat-sdk/session"),i=e("@aimpact/chat-sdk/startup");t.ChatCollectionProvider=class{#api;#parent;constructor(e){this.#api=new s.Api(i.sdkConfig.api),this.#parent=e}async list(){var e=await a.sessionWrapper.user.firebaseToken,{status:e,data:t}=(this.#api.bearer(e),await this.#api.get("/chats"));if(e)return{status:e,data:t};throw new Error("error loading chat")}}}}),h.set("./chats/interfaces/chat",{hash:824696355,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}}),h.set("./chats/interfaces/message",{hash:218835744,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}}),h.set("./chats/item/index",{hash:2203614448,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Chat=void 0;var s=e("@beyond-js/reactive/entities"),a=e("@aimpact/chat-sdk/api"),r=e("../messages/item"),i=e("../messages"),o=e("@beyond-js/kernel/core"),n=e("@aimpact/chat-sdk/startup"),c=e("./provider");class d extends s.Item{#api;properties=["id","autoplay","name","userId","system","parent","category","language","usage","children","knowledgeBoxId","user","metadata"];localdb=!1;#messages;get messages(){return this.#messages}constructor({id:e=void 0}={}){super({id:e,db:"chat-api",storeName:"Chat",provider:c.ChatProvider}),this.#api=new a.Api(n.sdkConfig.api),globalThis.chat=this}loadAll=async e=>{await this.isReady;var e=await this.load(e),t=new i.Messages;await t.localLoad({chatId:this.id,sortBy:"timestamp",limit:1e3}),t.on("change",this.triggerEvent),e.data.messages?.length&&await t.setEntries(e.data.messages),this.#messages=t,globalThis.m=t,globalThis.c=this};async setAudioMessage(e){try{var t=new r.Message;return await t.isReady,await t.saveMessage(e),this.triggerEvent(),t}catch(e){console.error(e)}}#currentAudio;async saveAudioLocally(e,t=void 0){try{var s=new r.Message,a=(await s.isReady,s.setOffline(!0),{chat:{id:this.id},chatId:this.id,type:"audio",audio:e,role:"user",language:this.language?.default??o.languages.current});return t&&(a.content=t),await(this.#currentAudio=s).saveMessage(a),this.setOffline(!1),this.triggerEvent(),s}catch(e){console.error(e)}}async sendMessage(s){try{this.fetching=!0;const i=new r.Message({chat:this});let e=new r.Message({chat:this}),t=(await Promise.all([i.isReady,e.isReady]),!1);const o=async()=>{t||(t=!0,e.publishSystem({offline:!0,specs:{chatId:this.id,chat:{id:this.id},conversation:{id:this.id},content:"",role:"system"}})),this.trigger(`message.${e.id}.updated`),e.updateContent({content:i.response}),e.triggerEvent(),this.triggerEvent()};i.on("content.updated",o),i.on("response.finished",()=>{e.updateContent({content:i.response}),this.trigger(`message.${e.id}.ended`),this.trigger(`message.${e.id}.updated`),i.off("content.updated",o)});var a={chatId:this.id,systemId:e.id,id:i.id,role:"user"};return"string"==typeof s?a.content=s:(a.multipart=!0,a.audio=s),i.publish(a),{message:i,response:e}}catch(e){console.error(e)}finally{this.fetching=!1}}getMessage(e){return this.#messages.get(e)}}t.Chat=d}}),h.set("./chats/item/provider",{hash:1822458863,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ChatProvider=void 0;var s=e("@aimpact/chat-sdk/api"),a=e("@aimpact/chat-sdk/startup"),i=e("@aimpact/chat-sdk/session");t.ChatProvider=class{#api;#parent;constructor(e){this.#api=new s.Api(a.sdkConfig.api),this.#parent=e}async load(e){var t=await i.sessionWrapper.user.firebaseToken,{status:t,data:s}=(this.#api.bearer(t),await this.#api.get("/chats/"+this.#parent.id));if(t)return{status:t,data:s};throw new Error("error loading chat")}}}}),h.set("./chats/messages/collection",{hash:2216528992,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Messages=void 0;var s=e("@beyond-js/reactive/entities"),a=e("./item");class i extends s.Collection{item=a.Message;storeName="Messages";db="chat-api";constructor(){super(),this.init()}}t.Messages=i}}),h.set("./chats/messages/index",{hash:1504257781,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Messages=void 0;var s=e("@beyond-js/reactive/entities"),a=e("./item");class i extends s.Collection{item=a.Message;constructor(){super({storeName:"Messages",db:"chat-api"})}}t.Messages=i}}),h.set("./chats/messages/item",{hash:3017684098,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Message=void 0;var s=e("@beyond-js/reactive/entities"),a=e("@aimpact/chat-sdk/api"),i=e("@aimpact/chat-sdk/session"),o=e("@beyond-js/kernel/core"),r=e("@aimpact/chat-sdk/startup");class n extends s.Item{properties=["id","chatId","audio","chat","userId","role","content","usage","timestamp"];#api;#response="";#chat;localFields=["audio"];#parsedContent;get response(){return this.#response}constructor({id:e=void 0,chat:t}={}){super({id:e,db:"chat-api",storeName:"Messages"}),this.#chat=t,e=new a.Api(r.sdkConfig.api),this.#api=e,this.reactiveProps(["autoplay"]),this.#listen(),this.initialise()}async initialise(){super.initialise()}#onListen=()=>{this.#response=this.#api.streamResponse,this.trigger("content.updated")};#listen=()=>{this.#api.on("stream.response",this.#onListen)};#offEvents=()=>{this.#api.off("stream.response",this.#onListen)};async publish(e){try{this.setOffline(!0);var t=new o.PendingPromise,s=await i.sessionWrapper.user.firebaseToken;return this.#api.bearer(s).stream(`/chats/${this.#chat.id}/messages`,{...e}).then(e=>{this.trigger("response.finished"),this.#offEvents()}).catch(e=>{console.error(e)}),this.#api.on("action.received",()=>{try{var e=this.#api?.actions?.find(e=>{if("transcription"===JSON.parse(e).type)return!0});e&&(e=JSON.parse(e),super.publish({content:e.data.transcription}))}catch(e){console.error(e)}}),super.publish(e),t}catch(e){console.trace(e)}}async publishSystem({offline:e,specs:t}){this.setOffline(e),super.publish(t)}async updateContent(e){this.setOffline(!0),await super.publish(e),this.trigger("content.updated")}}t.Message=n}}),h.set("./knowledge-boxes/collection",{hash:1543045298,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.KnowledgeBoxes=void 0;var s=e("@beyond-js/reactive/entities"),a=e("./item"),i=e("@aimpact/chat-sdk/api"),o=e("@aimpact/chat-sdk/session"),r=e("@aimpact/chat-sdk/config"),n=e("@aimpact/chat-sdk/startup");class c extends s.Collection{item=a.KnowledgeBox;#api;#project;#url=r.default.params.DOCUMENTS_SERVER;get api(){return this.#api}constructor(){super({storeName:"KnowledgeBoxes",db:"chat-api"}),this.#api=new i.Api(n.sdkConfig.api),this.#project=r.default.params.project}async list(e){try{this.fetching=!0;var t={type:"files",userId:o.sessionWrapper.userId,project:this.#project},s=(e&&(t.filter=e),await this.#api.get("/list",t));if(s.status)return s.data;throw new Error(s.error)}catch(e){console.error(e)}finally{this.fetching=!0}}async remove(e){try{if(!e)return{status:!1,error:"No path provided"};this.fetching=!0;var t={userId:o.sessionWrapper.userId,project:this.#project},s=await this.#api.delete("/delete",t);if(s.status)return s.data;throw new Error(s.error)}catch(e){console.error(e)}finally{this.fetching=!0}}}t.KnowledgeBoxes=c}}),h.set("./knowledge-boxes/item",{hash:1885230964,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.KnowledgeBox=void 0;class s extends e("@beyond-js/reactive/entities").Item{properties=["id","path","identifier","documents","type"];constructor({id:e=void 0}={}){super({id:e,db:"chat-api",storeName:"KnowledgeBoxes"})}}t.KnowledgeBox=s}}),d.exports.descriptor=[{im:"./audio/item",from:"Audio",name:"Audio"},{im:"./chats/collection/index",from:"Chats",name:"Chats"},{im:"./chats/interfaces/chat",from:"IChatProperties",name:"IChatProperties"},{im:"./chats/interfaces/chat",from:"IChat",name:"IChat"},{im:"./chats/item/index",from:"Chat",name:"Chat"},{im:"./chats/messages/item",from:"Message",name:"Message"},{im:"./knowledge-boxes/collection",from:"KnowledgeBoxes",name:"KnowledgeBoxes"},{im:"./knowledge-boxes/item",from:"KnowledgeBox",name:"KnowledgeBox"}],d.exports.process=function({require:e,prop:t,value:s}){!e&&"Audio"!==t||a("Audio",e?e("./audio/item").Audio:s),!e&&"Chats"!==t||a("Chats",e?e("./chats/collection/index").Chats:s),!e&&"IChatProperties"!==t||a("IChatProperties",e?e("./chats/interfaces/chat").IChatProperties:s),!e&&"IChat"!==t||a("IChat",e?e("./chats/interfaces/chat").IChat:s),!e&&"Chat"!==t||a("Chat",e?e("./chats/item/index").Chat:s),!e&&"Message"!==t||a("Message",e?e("./chats/messages/item").Message:s),!e&&"KnowledgeBoxes"!==t||a("KnowledgeBoxes",e?e("./knowledge-boxes/collection").KnowledgeBoxes:s),!e&&"KnowledgeBox"!==t||a("KnowledgeBox",e?e("./knowledge-boxes/item").KnowledgeBox:s)},a("__beyond_pkg",d),a("hmr",new function(){this.on=(e,t)=>d.hmr.on(e,t),this.off=(e,t)=>d.hmr.off(e,t)}),d.initialise(h)}}});