System.register(["@beyond-js/kernel@0.1.9/bundle","@beyond-js/reactive@1.1.12/model","@beyond-js/kernel@0.1.9/core","@aimpact/media-manager@1.0.0/main"],function(i,e){var t,r,s,a,o,n;return i({Uploader:void 0,XHRLoader:void 0}),{setters:[function(e){t=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=t.Bundle,(o=new n({module:{vspecifier:"@aimpact/media-manager@1.0.0/uploader"},type:"ts"},e.meta.url).package()).dependencies.update([["@beyond-js/reactive/model",r],["@beyond-js/kernel/core",s],["@aimpact/media-manager/main",a]]),(n=new Map).set("./draggable",{hash:2049727806,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.DraggableUploader=void 0,t.DraggableUploader=class{#parent;#files;constructor(e){this.#parent=e,this.#files=e.files}onDrop=e=>{e.preventDefault();var t=e.dataTransfer;if(t.items.length){var r=[];for(let e=0;e<t.items.length;++e){var i=t.items[e].getAsFile();i&&r.push(i)}this.#files.readLocal(r)}};onDragOver=e=>{e.preventDefault()};add(e){e.ondrop=this.onDrop,e.ondragover=this.onDragOver}}}}),n.set("./files/base",{hash:1807685762,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.BaseFile=void 0;var i=e("@beyond-js/kernel/core"),e=e("@beyond-js/reactive/model");class r extends e.ReactiveModel{#loaded=0;#specs;#type;regExp=/[^\w\d.]/g;#errors=[];get errors(){return this.#errors}_total=0;get total(){return this._total}set total(e){e!==this._total&&(this._total=e)}_items=new Map;get items(){return this._items}get entries(){return[...this._items.values()]}constructor(e,t){super(),this.#specs=t,this.#type=t.type||"any"}FILE_TYPE=Object.freeze({document:["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain","application/pdf"],image:["image/png","image/jpeg","image/gif"],json:["application/json"],zip:["application/x-zip-compressed"],audio:["audio/mpeg","audio/ogg","audio/wav","audio/webm","audio/aac","audio/flac","audio/x-m4a"]});#onload=e=>{e.target.removeEventListener("load",this.#onload),this.#specs.onload&&"function"==typeof this.#specs.onload&&this.#specs.onload(e)};#onloadend=(e,t)=>{this.#loaded=this.#loaded+1;var r=t.name.replace(this.regExp,"");(t=this._items.get(r)).src=e.target.result,this._items.set(r,t),e.target.removeEventListener("onloadend",this.#onloadend),this.triggerEvent("file.loaded"),this.#loaded===this._items.size&&this.triggerEvent("loadend"),this.#specs.onloadend&&"function"==typeof this.#specs.onloadend&&this.#specs.onload(e)};#onerror=e=>console.error(4,e);validate=t=>{var e=!!this.FILE_TYPE[this.#type].find(e=>e===t.type);return e||this.#errors.push(t.name.replace(this.regExp,"")),e};#readFile=async t=>{let r=new i.PendingPromise,e;if("any"===this.#type||await this.validate(t))return(e=new FileReader).onload=e=>this.#onload(e),e.onloadend=e=>{this.#onloadend(e,t),r.resolve()},e.onerror=e=>this.#onerror(e),e.readAsDataURL(t),r;this.triggerEvent("error")};#validateLoad=()=>{this.#loaded,this._items.size};clean=()=>{this._items=new Map,this.#loaded=0,this.triggerEvent()};readLocal=async t=>{this.fetching=!0;var r=[];for(let e=0;e<t.length;++e){var i=t[e];this._items.set(i.name.replace(this.regExp,""),i),r.push(this.#readFile(i))}await Promise.all(r),this.fetching=!1}}t.BaseFile=r}}),n.set("./files/index",{hash:1284523260,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.FilesUploader=void 0;var r=e("@beyond-js/reactive/model"),i=e("./mobile"),s=e("./web");class a extends r.ReactiveModel{static#instance;static getInstance(e,t){return this.#instance||(globalThis.phonegap?new i.MobileFilesUploader(e):new s.WebFilesUploader(e,t))}}t.FilesUploader=a}}),n.set("./files/mobile",{hash:1023732665,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.MobileFilesUploader=void 0,e=e("@beyond-js/reactive/model");class r extends e.ReactiveModel{_loaded=0;files=new Map;base64;_specs;_errors=[];constructor(e){super(),this._specs=e}clean=()=>{this.files=new Map,this._loaded=0};getFiles=async e=>{this.clean(),this.base64=e.url,this.triggerEvent("loading");var[,t]=e.name.split("com.jidadesarrollos.bovino/cache/");this.files.set(t,e.url),this.triggerEvent("loadend")};get entries(){return this.files}get total(){return this.files.size}}t.MobileFilesUploader=r}}),n.set("./files/web",{hash:4019010510,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.WebFilesUploader=void 0,e=e("./base");class r extends e.BaseFile{}t.WebFilesUploader=r}}),n.set("./index",{hash:2603848609,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Uploader=void 0;var r=e("@beyond-js/reactive/model"),i=e("./draggable"),s=e("./files"),l=e("./xhr"),a=e("@aimpact/media-manager/main");class o extends r.ReactiveModel{#files;get files(){return this.#files}#fileInput=document.createElement("input");#selector;#attrs;#draggable;#control;#specs;#errors;get errors(){return this.#errors}constructor(e={}){super(),e.input||(e.input={}),this.#files=s.FilesUploader.getInstance(this,e),this.#draggable=new i.DraggableUploader(this),(globalThis.up=this).#files.on("change",this.#listenChanges),this.#files.on("error",this.getErrors),this.#files.on("loadend",this.filesLoaded);var t={...e.input};e.hasOwnProperty("multiple")&&(t.multiple=e.multiple),this.#specs=e,this.setAttributes(t)}#listenChanges=()=>{this.fetching=this.#files.fetching,this.ready=this.#files.ready};setAttributes=e=>{var t,r={type:"file",style:"display:none",name:"input_upload",...e=e||{}};for(t in r.multiple&&(this.#fileInput.accept="directory/*"),r)this.#fileInput.setAttribute(t,r[t]);this.#attrs=r};openDialog=()=>{this.#fileInput.click()};filesLoaded=()=>this.triggerEvent("loadend");pictureLoaded=()=>this.triggerEvent("pictureLoaded");pictureLoading=()=>this.triggerEvent("pictureLoading");getErrors=()=>this.#errors=this.files.errors;clean=async()=>{await this.#files.clean()};delete=async e=>{await this.#files.items.delete(e),this.triggerEvent()};create=(e,t)=>{"MOBILE"===a.mediaDevice.type&&e.addEventListener("click",a.mediaDevice.openGallery),(this.#selector=e).after(this.#fileInput),e&&(e.addEventListener("click",this.openDialog),this.#fileInput.addEventListener("change",this.#onChangeInput)),t&&this.#draggable.add(t)};#onChangeInput=async e=>{this.clean(),this.fetching=!0,this.triggerEvent();let t=e.currentTarget;window.setTimeout(async()=>{this.#files.total=t.files.length,await this.#files.readLocal(t.files),this.fetching=!1,this.triggerEvent()},0)};publish=async(e={})=>{let t=new FormData,r=this.#files,i=this.#specs,s=1<r.total?""+i.name:i.name;var a,o=r.entries.map(e=>e),n=(t.append(s,JSON.stringify(o)),r.entries.forEach(e=>t.append(s,e)),i.params||(i.params={}),{...i.params,...e});for(a in n)n.hasOwnProperty(a)&&t.append(a,n[a]);return(await(new l.XHRLoader).upload(t,i.url)).json()}}t.Uploader=o}}),n.set("./resize",{hash:1913477879,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.resizePicture=void 0,t.resizePicture=(e,p)=>new Promise(n=>{let l=(p=p||{}).maxWidth||800,d=p.maxHeight||l/(4/3),h=p.quality||.8,c=new Image;c.src=e,c.onload=function(){let t=c.width,r=c.height,i;t<r?(i="portrait",r>d&&(t*=d/r,r=d)):(i="landscape",t>l&&(r*=l/t,t=l));var e=document.createElement("canvas");e.width=t,e.height=r,e.getContext("2d").drawImage(c,0,0,t,r),e=e.toDataURL("image/jpeg",h),p.rotate||n({src:e,width:t,height:r,orientation:i});let s=document.createElement("canvas"),a=s.getContext("2d"),o=(s.height=t,s.width=r,new Image);o.onload=()=>{a.translate(s.width/2,s.height/2),a.rotate(Math.PI/2),a.drawImage(o,-o.width/2,-o.height/2),a.rotate(-Math.PI/2),a.translate(-o.width/2,-o.height/2);var e=s.toDataURL("image/jpg",1);n({src:e,width:t,height:r,orientation:i,aja:!0})},o.src=e}})}}),n.set("./xhr",{hash:2968170215,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.XHRLoader=void 0,e=e("@beyond-js/reactive/model");class r extends e.ReactiveModel{promise;uploaded;progress;error;constructor(){super(),this.promise=void 0,this.uploaded=!1,this.progress=0,this.error=!1}#bearer;bearer(e){return e&&(this.#bearer=e),this}get uploading(){return!!this.promise}get isUploaded(){return this.uploaded}get uploadProgress(){return this.progress}get hasError(){return this.error}onProgress(e){e.lengthComputable&&(e=Math.round(100*e.loaded/e.total),this.progress=parseInt(e.toString())),this.triggerEvent("change")}onCompleted(e){this.uploaded=!0,this.promise.resolve(),this.triggerEvent("change"),setTimeout(()=>{this.promise=void 0,this.triggerEvent("change")},100)}onError(e){console.error("Error uploading picture",e),this.error=!0,this.promise.reject(),this.triggerEvent("change")}onAbort(){this.promise.resolve(!1),this.triggerEvent("change")}getHeaders=t=>{let r=new Headers,e=t.bearer||this.#bearer;return e&&r.append("Authorization","Bearer "+e),t.bearer&&delete t.bearer,Object.keys(t).forEach(e=>{"bearer"!==e&&r.append(e,t[e])}),r};async upload(e,t){try{var r=this.getHeaders({});return fetch(t,{method:"post",headers:r,body:e})}catch(e){console.error("error",e)}}abort(){this.promise&&(this.promise.reject(),this.triggerEvent("change"))}}t.XHRLoader=r}}),o.exports.descriptor=[{im:"./index",from:"Uploader",name:"Uploader"},{im:"./xhr",from:"XHRLoader",name:"XHRLoader"}],o.exports.process=function({require:e,prop:t,value:r}){!e&&"Uploader"!==t||i("Uploader",e?e("./index").Uploader:r),!e&&"XHRLoader"!==t||i("XHRLoader",e?e("./xhr").XHRLoader:r)},i("__beyond_pkg",o),i("hmr",new function(){this.on=(e,t)=>o.hmr.on(e,t),this.off=(e,t)=>o.hmr.off(e,t)}),o.initialise(n)}}});