System.register(["@beyond-js/kernel@0.1.9/bundle","@beyond-js/reactive@1.2.0/model","@aimpact/http-suite@0.0.1/api","@aimpact/chat-sdk@1.1.0/session","@aimpact/chat-sdk@1.1.0/startup","@beyond-js/reactive@1.2.0/entities","@beyond-js/reactive@1.2.0/database","@beyond-js/kernel@0.1.9/core","uuid@10.0.0","@aimpact/chat-sdk@1.1.0/config"],function(a,e){var t,s,i,r,n,o,c,h,d,p,u,m;return a({Chats:void 0,IChatProperties:void 0,IChat:void 0,Chat:void 0,Message:void 0}),{setters:[function(e){t=e},function(e){s=e},function(e){i=e},function(e){r=e},function(e){n=e},function(e){o=e},function(e){c=e},function(e){h=e},function(e){d=e},function(e){p=e}],execute:function(){m=t.Bundle,(u=new m({module:{vspecifier:"@aimpact/chat-sdk@1.1.0/core"},type:"ts"},e.meta.url).package()).dependencies.update([["@beyond-js/reactive/model",s],["@aimpact/http-suite/api",i],["@aimpact/chat-sdk/session",r],["@aimpact/chat-sdk/startup",n],["@beyond-js/reactive/entities",o],["@beyond-js/reactive/database",c],["@beyond-js/kernel/core",h],["uuid",d],["@aimpact/chat-sdk/config",p]]),(m=new Map).set("./chats/collection/index",{hash:1392919199,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Chats=void 0;var s=e("@beyond-js/reactive/model"),a=e("@aimpact/http-suite/api"),i=e("@aimpact/chat-sdk/session"),r=e("@aimpact/chat-sdk/startup");class n extends s.ReactiveModel{#api;constructor(e){super(),this.#api=new a.Api(r.sdkConfig.api)}#items=[];get items(){return this.#items}async load(){var e=await i.sessionWrapper.user.firebaseToken,{status:e,data:t}=(this.#api.bearer(e),await this.#api.get("/chats"));if(e)return this.#items=t.items,{status:e,data:t};throw new Error("error loading chat")}async addItem(e){this.#items.unshift(e),this.triggerEvent("change")}}t.Chats=n}}),m.set("./chats/collection/provider",{hash:525430157,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ChatCollectionProvider=void 0;var s=e("@aimpact/http-suite/api"),a=e("@aimpact/chat-sdk/session"),i=e("@aimpact/chat-sdk/startup");t.ChatCollectionProvider=class{#api;#parent;constructor(e){this.#api=new s.Api(i.sdkConfig.api),this.#parent=e}async list(){var e=await a.sessionWrapper.user.firebaseToken,{status:e,data:t}=(this.#api.bearer(e),await this.#api.get("/chats"));if(e)return{status:e,data:t};throw new Error("error loading chat")}}}}),m.set("./chats/interfaces/chat",{hash:824696355,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}}),m.set("./chats/interfaces/message",{hash:867918171,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}}),m.set("./chats/item/index",{hash:1383264609,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Chat=void 0;var s=e("@beyond-js/reactive/database"),n=e("@beyond-js/kernel/core"),a=e("@beyond-js/reactive/entities"),i=e("@aimpact/http-suite/api"),o=e("../messages/item"),r=e("../messages"),c=e("@aimpact/chat-sdk/session"),h=e("@aimpact/chat-sdk/startup"),d=e("./provider"),p=e("uuid");class u extends a.Item{#api;get api(){return this.#api}properties=["id","autoplay","name","userId","system","parent","category","language","usage","children","knowledgeBoxId","user","metadata"];localdb=!1;#currentMessage;#response;#messages;get messages(){return this.#messages}constructor({id:e=void 0}={}){super({id:e,localdb:!1,provider:d.ChatProvider}),this.#api=new i.Api(h.sdkConfig.api),this.#messages=new r.Messages,this.#messages.on("new.message",()=>this.triggerEvent("new.message")),globalThis.chat=this,e||(this.id=(0,p.v4)()),this.#listen(),globalThis.chat=this}#listen=()=>{this.#api.on("stream.response",this.#onListen),this.#api.on("action.received",()=>{try{this.#api.actions&&this.#api.actions.forEach(e=>{"transcription"===(e=JSON.parse(e)).type&&this.#currentMessage.set({content:e.data.transcription,streaming:!1})})}catch(e){console.log("no ta listo",e)}})};#offEvents=()=>{this.#api.off("stream.response",this.#onListen)};loadAll=async e=>{await this.isReady;var e=await this.load(e),t=this.#messages;t.on("change",this.triggerEvent),e.data.messages?.length&&await t.setEntries(e.data.messages),this.#messages=t};#onListen=()=>{this.#response&&(this.#response.content=this.#api.streamResponse,this.#response.set({content:this.#api.stringContent,actions:this.#api.actions}),this.trigger("content.updated"))};getData(){var e=this.getProperties();return e.messages=this.#messages.getData(),e}async sendMessage(i){try{this.fetching=!0;let e=await c.sessionWrapper.user.firebaseToken,t=`/chats/${this.id}/messages`,s=new n.PendingPromise,a=new o.Message({chatId:this.id,content:i});return this.#currentMessage=a,this.#response=new o.Message({chatId:this.id,role:"system",streaming:!0}),this.messages.add(a),this.messages.add(this.#response),this.#api.bearer(e).stream(t,{...a.getProperties()}).then(async e=>{this.trigger("response.finished"),await this.#response.set({streaming:!1}),this.#response=void 0,s.resolve(a),this.saveLocally(this.getData())}).catch(e=>{console.error(e)}),s}catch(i){console.error(i)}finally{this.fetching=!1}}async sendAudio(r){try{this.fetching=!0;let e=await c.sessionWrapper.user.firebaseToken,t=`/chats/${this.id}/messages/audio`,s=new n.PendingPromise,a=new o.Message({chatId:this.id,audio:r,streaming:!0}),i=(this.#currentMessage=a,async e=>{await this.#response.set({streaming:!1}),this.trigger("response.finished"),this.#response=void 0,s.resolve(a),this.saveLocally(this.getData())});return this.messages.add(a),this.#response=new o.Message({chatId:this.id,role:"system",streaming:!0}),this.messages.add(this.#response),this.#api.bearer(e).stream(t,{...a.getProperties(),multipart:!0}).then(i).catch(e=>{console.error(e)}),globalThis.setTimeout(()=>i(),3e3),s}catch(e){console.error(e)}finally{this.fetching=!1}}async transcribe(e){try{var t=await c.sessionWrapper.user.firebaseToken;return await this.#api.bearer(t).post("/audios/transcribe",{multipart:!0,audio:e})}catch(e){throw e}}getMessage(e){return this.#messages.get(e)}response(e){return{status:!0,data:e}}async saveLocally(e){try{return null}catch(e){console.error("Error saving locally:",e)}}async loadLocally(e){try{return await s.DBManager.db.table("Chat").get(e)}catch(e){console.error("Error loading locally:",e)}}async create(){var e=await this.#api.post("/chats",{id:this.id,name:"My chat",projectId:"02d991dd-8d57-42f3-b155-8e7133482c19",uid:c.sessionWrapper.user.id,metadata:{prompt:"topic-q&a"},language:{default:"es"}});this.set(e.data)}}t.Chat=u}}),m.set("./chats/item/provider",{hash:3635996534,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ChatProvider=void 0;var s=e("@aimpact/http-suite/api"),a=e("@aimpact/chat-sdk/startup"),i=e("@aimpact/chat-sdk/session");t.ChatProvider=class{#api;#parent;constructor(e){this.#api=new s.Api(a.sdkConfig.api),this.#parent=e}async load(e){var t=await i.sessionWrapper.user.firebaseToken,{status:t,data:s}=(this.#api.bearer(t),await this.#api.get("/chats/"+this.#parent.id));if(t)return{status:t,data:s};throw new Error("error loading chat")}}}}),m.set("./chats/messages/index",{hash:817968774,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Messages=void 0;var s=e("./item"),e=e("@beyond-js/reactive/model");class a extends e.ReactiveModel{item=s.Message;#items=[];#map=new Map;get items(){return this.#items}constructor(){super()}setEntries(e){this.#items=e.map(e=>(e=new s.Message(e),this.#map.set(e.id,e),e))}get(e){return this.#map.get(e)}add(e){this.#items.push(e),this.#map.set(e.id,e),this.trigger("new.message")}getData(){return this.#items.map(e=>e.getProperties())}}t.Messages=a}}),m.set("./chats/messages/item",{hash:4035288771,creator:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Message=void 0;var s=e("@beyond-js/reactive/model"),a=e("uuid"),i=e("@aimpact/http-suite/api"),r=e("@aimpact/chat-sdk/startup");class n extends s.ReactiveModel{#api;#response="";#chat;localFields=["audio"];#parsedContent;get response(){return this.#response}#type;get type(){return this.#type}constructor({id:e=void 0,chat:t,...s}){super({id:e,...s,properties:["id","chatId","audio","userId","role","content","usage","timestamp","streaming","actions"]}),this.#chat=t,e||(this.id=(0,a.v4)()),t=new i.Api(r.sdkConfig.api),this.#api=t,this.#type=s.type??"message",this.reactiveProps(["autoplay"]),super.ready=!0}}t.Message=n}}),u.exports.descriptor=[{im:"./chats/collection/index",from:"Chats",name:"Chats"},{im:"./chats/interfaces/chat",from:"IChatProperties",name:"IChatProperties"},{im:"./chats/interfaces/chat",from:"IChat",name:"IChat"},{im:"./chats/item/index",from:"Chat",name:"Chat"},{im:"./chats/messages/item",from:"Message",name:"Message"}],u.exports.process=function({require:e,prop:t,value:s}){!e&&"Chats"!==t||a("Chats",e?e("./chats/collection/index").Chats:s),!e&&"IChatProperties"!==t||a("IChatProperties",e?e("./chats/interfaces/chat").IChatProperties:s),!e&&"IChat"!==t||a("IChat",e?e("./chats/interfaces/chat").IChat:s),!e&&"Chat"!==t||a("Chat",e?e("./chats/item/index").Chat:s),!e&&"Message"!==t||a("Message",e?e("./chats/messages/item").Message:s)},a("__beyond_pkg",u),a("hmr",new function(){this.on=(e,t)=>u.hmr.on(e,t),this.off=(e,t)=>u.hmr.off(e,t)}),u.initialise(m)}}});